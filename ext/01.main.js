oxfApp.config.headerBackground = '#2BA2B7';
oxfApp.config.headerBackgroundTag = 'header_color_';
oxfApp.config.breadcrumbColor = '#FFFFFF';
oxfApp.config.breadcrumbColorTag = 'breadcrumb_color_';

oxfApp.config.tagDropdown = "block_dropdown";
oxfApp.config.tagTextCenter = "block_text_center";
oxfApp.config.tagTextUpCenter = "block_text_up_center";
oxfApp.config.tagTextUpLeft = "block_text_up_left";
oxfApp.config.tagTextUpRight = "block_text_up_right";
oxfApp.config.tagBackgroundColorHelp = "home_help_background_color_";
oxfApp.config.tagBorderColorHelp = "home_help_border_color_";
oxfApp.config.tagBlockEbook = "block_ebook";
oxfApp.config.tagBlockEbooks = "block_ebooks";
oxfApp.config.tagResourceTeacher = "hidden_resource_";
oxfApp.config.cardView = "cards_view";
oxfApp.config.evauAbstracts = "evau_abstracts";
oxfApp.config.evauExams = "evau_exams";
oxfApp.config.examsOnline = "exams_online";
oxfApp.config.ebookExamsGenerator = "block_ebook_exams_generator";

oxfApp.config.oxfordExamsId = 0;

oxfApp.config.canLockActivities = false;
oxfApp.config.activityLocked = 8;

oxfApp.icons.units = '<svg width="73" height="56" viewBox="0 0 73 56" xmlns="http://www.w3.org/2000/svg"><path d="M68.48 7.78h-.67v-2a3.78 3.78 0 0 0-3.94-3.58h-8.13A2.06 2.06 0 0 0 53.66.51H47a2 2 0 0 0-2.08 1.69h-.66a8.79 8.79 0 0 0-7.58 4.08A8.82 8.82 0 0 0 29.1 2.2H9.46a3.78 3.78 0 0 0-3.94 3.58v2h-.67a4.3 4.3 0 0 0-4.49 4.07v39.91a4.3 4.3 0 0 0 4.49 4.07h63.63A4.3 4.3 0 0 0 73 51.76V11.85a4.3 4.3 0 0 0-4.52-4.07ZM44.27 4.13h.64v12.69A1.85 1.85 0 0 0 48 18l2.33-2.07L52.66 18a1.85 1.85 0 0 0 2.61-.08c.278-.3.45-.683.49-1.09V11a1.07 1.07 0 0 0-1.17-1 1.09 1.09 0 0 0-1 1v5.15l-2-1.8a2 2 0 0 0-2.55 0l-2 1.8V2.44h6.59V15.6c0 .53.48-4.6 1.07-4.6.59 0 1.06.53 1.06 0V4.13h8.11a1.73 1.73 0 0 1 1.82 1.64V47.6a1.73 1.73 0 0 1-1.82 1.64H37.75V10c.03-3.24 2.94-5.87 6.52-5.87Zm26.57 47.63a2.26 2.26 0 0 1-2.36 2.14H4.85a2.26 2.26 0 0 1-2.36-2.14V11.85a2.26 2.26 0 0 1 2.36-2.14h.67v29.35a1.06 1.06 0 0 0 2.12 0V5.77a1.74 1.74 0 0 1 1.82-1.64H29.1c3.58 0 6.5 2.63 6.52 5.87v39.24H9.46a1.73 1.73 0 0 1-1.81-1.64v-8.54a.75.75 0 0 0-.63-.85.69.69 0 0 0-.2 0c-.59 0-1.3.33-1.3.86v8.53a3.77 3.77 0 0 0 3.94 3.57h54.41a3.76 3.76 0 0 0 3.94-3.57V9.71h.67a2.25 2.25 0 0 1 2.36 2.14v39.91Z" fill="#202E55" fill-rule="nonzero"/></svg>';
oxfApp.icons.resources = '<svg width="60" height="54" viewBox="0 0 60 54" xmlns="http://www.w3.org/2000/svg"><path d="M2.12 11.35h51.12V9.58a2 2 0 0 0-2.13-1.76H21.85a2.42 2.42 0 0 1-1.73-.69L16 2.85a1.21 1.21 0 0 0-.83-.33H4.25a2 2 0 0 0-2.13 1.77v7.06ZM15.16.76a3.45 3.45 0 0 1 2.49 1L21.78 6h29.33c2.35 0 4.26 1.59 4.26 3.53v1.91h.02a4.09 4.09 0 0 1 4 4.21v33.73a4.09 4.09 0 0 1-4 4.21H4a4.09 4.09 0 0 1-4-3.977V15.65c-.005-.16 0-.318.014-.475C.004 15.18 0 15.16 0 15.11V4.29C0 2.34 1.91.76 4.26.76h10.9Zm40.23 12.78H4a2.06 2.06 0 0 0-2 2.11v33.73a2.05 2.05 0 0 0 2 2.11h51.39a2 2 0 0 0 2-2.11V15.65a2 2 0 0 0-2-2.11Zm-30.573 8.246a2.611 2.611 0 0 1 1.773.366l12.952 8.088a2.63 2.63 0 0 1-.012 4.428l-12.932 8.075a2.593 2.593 0 0 1-1.388.407 2.62 2.62 0 0 1-2.62-2.62V24.366c.002-.49.143-.97.4-1.372a2.61 2.61 0 0 1 1.624-1.168Zm.349 1.972-.096.015a.62.62 0 0 0-.387.285.587.587 0 0 0-.093.312v16.16c0 .342.278.62.616.62a.6.6 0 0 0 .324-.098l12.928-8.072a.63.63 0 0 0 .012-1.052L25.532 23.85a.61.61 0 0 0-.462-.076ZM2 26.19c0-.58-.44-.24-1-.24s-1-.34-1 .24a1 1 0 0 0 2 0Z" fill="#202E55" fill-rule="nonzero"/></svg>';
oxfApp.icons.lockUnlock = '<svg width="24" height="34" viewBox="0 0 24 34" xmlns="http://www.w3.org/2000/svg"><path d="M21.53 13.8H6.73V9a5.15 5.15 0 0 1 4-5.1A5 5 0 0 1 16.52 8c.051.28.078.565.08.85a1.65 1.65 0 1 0 3.29 0A8.25 8.25 0 0 0 11.63.6h-.78a8.53 8.53 0 0 0-7.4 8.55v4.6H1.8A1.65 1.65 0 0 0 .16 15.4v16.49a1.76 1.76 0 0 0 1.64 1.64h19.73a1.66 1.66 0 0 0 1.65-1.64V15.44a1.56 1.56 0 0 0-1.46-1.64h-.19Zm-8.22 11V27A1.655 1.655 0 1 1 10 27v-2.18A3.4 3.4 0 0 1 8.38 22a3.26 3.26 0 0 1 3.28-3.24c.28.001.56.038.83.11A3.72 3.72 0 0 1 15 21.36a3.21 3.21 0 0 1-1.69 3.46v-.02Z" fill="#8EC371" fill-rule="nonzero"/></svg>';
oxfApp.icons.lockLocked = '<svg width="24" height="34" viewBox="0 0 24 34" xmlns="http://www.w3.org/2000/svg"><path d="M22 13.8H7.24V9a5.15 5.15 0 0 1 3.95-5.1A5 5 0 0 1 17 8c.051.28.078.565.08.85v6h2l1.3.53V8.87A8.26 8.26 0 0 0 12.12.61h-.78A8.54 8.54 0 0 0 4 9.19v4.6H2.31a1.65 1.65 0 0 0-1.64 1.65v16.45a1.76 1.76 0 0 0 1.64 1.64H22a1.66 1.66 0 0 0 1.65-1.64V15.44a1.56 1.56 0 0 0-1.46-1.64H22Zm-8.22 11V27a1.65 1.65 0 1 1-3.29 0v-2.18A3.43 3.43 0 0 1 8.89 22a3.26 3.26 0 0 1 3.28-3.24c.28.001.56.038.83.11a3.72 3.72 0 0 1 2.47 2.47 3.19 3.19 0 0 1-1.65 3.48l-.04-.02Z" fill="#202E55" fill-rule="nonzero"/></svg>';
oxfApp.icons.eye = '<svg width="77" height="49" viewBox="0 0 77 49" xmlns="http://www.w3.org/2000/svg"><path d="M38.58 9.46A14.94 14.94 0 1 0 53.52 24.4c-.033-8.237-6.703-14.907-14.94-14.94Zm0-9.13c20.54 0 36.62 21.68 37.29 22.6a2.49 2.49 0 0 1 0 2.94c-.67.92-16.75 22.6-37.29 22.6S1.96 26.79 1.29 25.87a2.49 2.49 0 0 1 0-2.94C2 22 18.04.33 38.58.33Zm0 4.98c-15.11 0-28.24 14.38-32.11 19.09 3.88 4.7 16.98 19.09 32.11 19.09 15.16 0 28.23-14.38 32.11-19.09-3.88-4.71-17-19.09-32.11-19.09Zm0 9.05c5.523 0 10 4.477 10 10s-4.477 10-10 10-10-4.477-10-10 4.477-10 10-10Z" fill="#323232" fill-rule="nonzero"/></svg>';
oxfApp.icons.download = '<svg width="34" height="34" viewBox="0 0 34 34" xmlns="http://www.w3.org/2000/svg"><path d="M32.07 20.64a1.5 1.5 0 0 1 1.493 1.356l.007.144v6.77a4.88 4.88 0 0 1-4.663 4.875l-.217.005H5a4.88 4.88 0 0 1-4.875-4.663L.12 28.91v-6.77a1.5 1.5 0 0 1 2.993-.144l.007.144v6.77c0 .989.763 1.8 1.733 1.874L5 30.79h23.69c.989 0 1.8-.763 1.874-1.733l.006-.147v-6.77a1.5 1.5 0 0 1 1.5-1.5ZM16.85.35a1.5 1.5 0 0 1 1.493 1.356l.007.144-.001 16.67 5.901-5.891a1.5 1.5 0 0 1 2.223 2.008l-.103.114-8.376 8.37a1.497 1.497 0 0 1-2.288 0L7.33 14.75a1.5 1.5 0 0 1 2.006-2.225l.114.103 5.899 5.891.001-16.67a1.5 1.5 0 0 1 1.5-1.5Z" fill="#202E55" fill-rule="nonzero"/></svg>';
oxfApp.icons.addResource = '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M13 7h-2v4H7v2h4v4h2v-4h4v-2h-4V7zm-1-5C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/></svg>';

oxfApp.text.oxford_geniox_pageperunit = textweb('oxford_geniox_pageperunit'); //"Páginas por unidad";
oxfApp.text.oxford_geniox_resourcesperunit = textweb('oxford_geniox_resourcesperunit'); //"Recursos por unidad";
oxfApp.text.oxford_geniox_showpins = textweb('oxford_geniox_showpins'); //"Mostrar pines";
oxfApp.text.oxford_geniox_close = textweb('oxford_geniox_close'); //"Cerrar";
oxfApp.text.oxford_geniox_addresource = textweb('oxford_geniox_addresource'); //"Añade tu recurso";
oxfApp.text.oxford_geniox_pags = textweb('oxford_geniox_pags'); //"Pág.";
oxfApp.text.oxford_geniox_downloadFile = textweb('oxford_geniox_downloadFile'); //"Descargar imprimible";
oxfApp.text.oxford_geniox_toggleVisibility = textweb('oxford_geniox_toggleVisibility'); //"Bloquear/Desbloquear examen";
oxfApp.text.oxford_geniox_exam_name = textweb('oxford_geniox_exam_name'); //"Nombre";
oxfApp.text.oxford_geniox_exam_grade = textweb('oxford_geniox_exam_grade'); //"Nota";
oxfApp.text.oxford_geniox_exam_status = textweb('oxford_geniox_exam_status'); //"Estado";
oxfApp.text.oxford_geniox_exam_evau_locked_1 = textweb('oxford_geniox_exam_evau_locked_1'); //"No tienes acceso a esta prueba.";
oxfApp.text.oxford_geniox_exam_evau_locked_2 = textweb('oxford_geniox_exam_evau_locked_2'); //"Este contenido todavía no ha sido desbloqueado por el profesor.";
oxfApp.text.oxford_geniox_accept = textweb('oxford_geniox_accept'); //"Aceptar";
oxfApp.text.oxford_geniox_cancel = textweb('oxford_geniox_cancel'); //"Cancelar";
oxfApp.text.oxford_geniox_resource_text_general = textweb('oxford_geniox_resource_text_general'); //"Abrir recurso";
oxfApp.text.oxford_geniox_resource_text_activity = textweb('oxford_geniox_resource_text_activity'); //"Ver actividad";
oxfApp.text.oxford_geniox_resource_text_document = textweb('oxford_geniox_resource_text_document'); //"Ver documento";
oxfApp.text.oxford_geniox_resource_text_video = textweb('oxford_geniox_resource_text_video'); //"Ver vídeo";
oxfApp.text.oxford_geniox_new = textweb('oxford_geniox_new'); //"¡Nuevo!";
oxfApp.text.oxford_geniox_exam_online_locked_1 = textweb('oxford_geniox_exam_online_locked_1'); //"Vas a desbloquear esta prueba.";
oxfApp.text.oxford_geniox_exam_online_locked_2 = textweb('oxford_geniox_exam_online_locked_2'); //"Esto significa que será visible para tus alumnos y tendrán acceso a ella.";
oxfApp.text.oxford_geniox_exam_online_unlocked_1 = textweb('oxford_geniox_exam_online_unlocked_1'); //"Vas a bloquear esta prueba.";
oxfApp.text.oxford_geniox_exam_online_unlocked_2 = textweb('oxford_geniox_exam_online_unlocked_2'); //"Esto significa que dejará de ser visible para tus alumnos y perderán cualquier progreso realizado.";
oxfApp.text.oxford_geniox_unlock = textweb('oxford_geniox_unlock'); //"Desbloquear";
oxfApp.text.oxford_geniox_lock = textweb('oxford_geniox_lock'); //"Bloquear";
oxfApp.text.oxford_geniox_test = textweb('oxford_geniox_test'); //"Test de unidad";
oxfApp.text.oxford_geniox_start_test = textweb('oxford_geniox_start_test'); //"Hacer test";
oxfApp.text.oxford_geniox_start_test_1 = textweb('oxford_geniox_start_test_1'); //"Vas a realizar el test del resumen.";
oxfApp.text.oxford_geniox_start_test_2 = textweb('oxford_geniox_start_test_2'); //"Una vez dentro, no podrás volver al resumen hasta que no se entregue.";
oxfApp.text.oxford_geniox_complete_activity = "Debes completar la actividad para continuar leyendo el resumen.";
oxfApp.text.oxford_geniox_grade_label = "Nota:";
oxfApp.text.oxford_geniox_make_visible = "Hacer visible";
oxfApp.text.oxford_geniox_make_visible_1 = "Vas a hacer visible este archivo.";
oxfApp.text.oxford_geniox_make_visible_2 = "Esto significa que será visible para tus alumnos y tendrán acceso a él.";
oxfApp.text.oxford_geniox_hidden = "Ocultar";
oxfApp.text.oxford_geniox_hidden_1 = "Vas a ocultar este archivo.";
oxfApp.text.oxford_geniox_hidden_2 = "Esto significa que dejará de ser visible para tus alumnos y no tendrán acceso a él.";
oxfApp.text.oxford_geniox_teacher_resources = "Recursos del profesor";


oxfApp.allExams = [];
oxfApp.newExams = [];
oxfApp.newExamsOnline = [];


// Get template

oxfApp.getTemplate = function (templateName) {
  switch (templateName) {
    case "1_rectangle":
      return ["1col ox-grid--lowerheight", 99, 1];
      break;
    case "1_left_1_square_right":
      return ["2items", 99, 2];
      break;
    case "1_square_left_1_right":
      return ["2items-reverse", 99, 2];
      break;
    case "2_rectangle":
      return ["2col ox-grid--lowerheight", 99, 2];
      break;
    case "2_left_1_right":
      return ["3items-reverse", 99, 3];
      break;
    case "1_left_2_right":
      return ["3items", 99, 3];
      break;
    case "3rectangle":
      return ["3col ox-grid--lowerheight", 99, 3];
      break;
    case "3_rectangle":
      return ["3col ox-grid--lowerheight", 99, 3];
      break;
    case "3_square":
      return ["3col", 99, 3];
      break;
    case "4_square":
      return ["4col ox-grid--lowerheight", 99, 4];
      break;
    case "4_rectangle":
      return ["4items", 99, 4];
      break;
    case "1_square_left_4_right":
      return ["5items", 99, 5];
      break;
    case "1_rectangle_left_4_right":
      return ["5items-bis", 99, 5];
      break;
    case "6_rectangle":
      return ["6items", 99, 6];
      break;
    case "1_left_2_centre_4right":
      return ["7items", 99, 7];
      break;
    case "1_left_8_right":
      return ["9items", 99, 9];
      break;
    case "12_square":
      return ["12items", 99, 12];
      break;
    case "template1": //OLD
      return ["7items", 99, 7];
      break;
    case "template2": //OLD
      return ["2items-reverse", 99, 2];
      break;
    case "5_square": //NEW
      return ["5items-square", 99, 5];
      break;
    case "4_rectangle_inline": //NEW
      return ["4items-nowrap", 99, 4];
      break;
    case "1_left_1_square_right_ebook": //NEW
      return ["2items", 99, 99];
      break;
    default:
      return [
        oxfApp.config.templateDefault,
        99,
        oxfApp.config.templateDefaultTotal
      ];
  }
};


oxfApp.getTemplateByLength = function (length) {
  switch (length) {
    case 1:
      return ["1col ox-grid--lowerheight", 99, 1];
      break;
    case 2:
      return ["2items", 99, 2];
      break;
    case 3:
      return ["3items", 99, 3];
      break;
    case 4:
      return ["4items-nowrap", 99, 4];
      break;
    case 5:
      return ["5items-bis", 99, 5];
      break;
    case 6:
      return ["6items", 99, 6];
      break;
    case 7:
      return ["7items", 99, 7];
      break;
    case 9:
      return ["9items", 99, 9];
      break;
    case 12:
      return ["12items", 99, 12];
      break;
    default:
      return [
        oxfApp.config.templateDefault,
        99,
        oxfApp.config.templateDefaultTotal,
      ];
  }
};
// Get text for downloadble file

oxfApp.getTextbyFileType = function (type) {
  switch (type) {
    case "actividad":
      return oxfApp.text.oxford_geniox_resource_text_activity;
      break;
    case "video":
      return oxfApp.text.oxford_geniox_resource_text_video;
      break;
    case "archivo":
      return oxfApp.text.oxford_geniox_resource_text_document;
      break;
    case "archivo-pdf":
      return oxfApp.text.oxford_geniox_resource_text_document;
      break;
    case "archivo-word":
      return oxfApp.text.oxford_geniox_resource_text_document;
      break;
    case "archivo-ppt":
      return oxfApp.text.oxford_geniox_resource_text_document;
      break;
    case "archivo-zip":
      return oxfApp.text.oxford_geniox_resource_text_general;
      break;
    default:
      return oxfApp.text.oxford_geniox_resource_text_general;
  }
};

//Overwrite CLose Activity

oxfApp.closeActivity = function() {
  var ishtmlBook = $('body').hasClass('body_htmlBook');

  if (blink.isApp && !blink.isOfflinePCApp) {
    blink.rest.closeWindow();
  } else {
    if (window.esPopup) {
      window.top.cerrarIframe()
    } else {
      if (modoactual == 'standalone') {
        window.history.back();
      } else if (ishtmlBook) {
        oxfApp.goHome();
      } else {
        closeActivity();
      }
    }
  }
}

//Overwrite MInHeight

oxfApp.minHeightSlides = function() {

  var $minHeight = $('#actividad .item-container');
  var $minHeightTarget = $('#actividad .item-container, #actividad .class_slide');
  var $heightCanvas = $('#activity-canvas');

  var belowBarHeight = 0; // Former 24

  if ($minHeight.length) {

    var offsetTop = $minHeight.offset().top,
        minHeight = oxfApp.windowHeight - offsetTop - belowBarHeight;

    $minHeightTarget.css('min-height', minHeight);
    $heightCanvas.css('height', minHeight - 12);
  }

  var $minHeightContent = $('#actividad .content');

  if ($minHeightContent.length) {

    var offsetTopContent = $minHeightContent.offset().top,
        minHeightContent = oxfApp.windowHeight - offsetTopContent - belowBarHeight;
    $minHeightContent.css('height', minHeightContent);
  }

}

//Utils: Detect URL parameter hashFrom and add it
oxfApp.getURL = function(str) {
  var url = str.substring(
    str.indexOf("'") + 1, 
    str.lastIndexOf("'")
  );
  var pre = str.substring(
    0,
    str.indexOf("'"), 
  );
  var post = str.substring(
    str.lastIndexOf("'")
  );
  return [url, pre, post];
}

oxfApp.updateOnclickTitle = function(onclicktitle, hashFrom) {

  var url = oxfApp.getURL(onclicktitle)[0];
  var pre = oxfApp.getURL(onclicktitle)[1];
  var post = oxfApp.getURL(onclicktitle)[2];

  var base = window.location.origin;

  var completeUrl = new URL(url, base);
  var params = new URLSearchParams(completeUrl.search);
  
  params.set('hashFrom', hashFrom);
  params.toString();

  params = pre+"'?"+params+post;

  return params;

}



// Header colors

oxfApp.headerColorsGeniox = function(unitID) {

  var bgcolor = oxfApp.config.headerBackground;
  var color = oxfApp.config.breadcrumbColor;

  var unitIDExists = (oxfApp.config.unitsNblockIDs.indexOf(unitID) >= 0);

  if (unitID && unitIDExists) {

    var resourceInfo = oxfApp.getResourcesInfo(unitID);
    var parentTags = resourceInfo[1].data.tags;
    var parentTags = (typeof parentTags !== 'undefined') ? parentTags.split(" ") : [];

    var hasCustomColors = false;
    if (parentTags != null && parentTags.length) {
      $.each(parentTags, function(index, value) {
        value = value.toLowerCase();

        if (oxfApp.startsWith(value, oxfApp.config.resourceHeaderBackgroundTag)) {
          bgcolor = value.replace(oxfApp.config.resourceHeaderBackgroundTag, '#');
          hasCustomColors = true;
        }
        if (oxfApp.startsWith(value, oxfApp.config.headerBackgroundTag)) {
          bgcolor = value.replace(oxfApp.config.headerBackgroundTag, '#');
          hasCustomColors = true;
        }
        if (oxfApp.startsWith(value, oxfApp.config.breadcrumbColorTag)) {
          color = value.replace(oxfApp.config.breadcrumbColorTag, '#');
          hasCustomColors = true;
        }
      });
    }
    if (!hasCustomColors) {
      var generalCourseTags = oxfApp.courseData.courseTags;

      if (generalCourseTags != null && generalCourseTags.length) {
        $.each(generalCourseTags, function(index, value) {
          value = value.toLowerCase();

          if (oxfApp.startsWith(value, oxfApp.config.headerBackgroundTag)) {
            bgcolor = value.replace(oxfApp.config.headerBackgroundTag, '#');
          }
          if (oxfApp.startsWith(value, oxfApp.config.breadcrumbColorTag)) {
            color = value.replace(oxfApp.config.breadcrumbColorTag, '#');
          }
        });
      }
    }

    $('.ox-resourcessection-header').css({'background-color': bgcolor, 'color': color}).find('.ox-title').css('color', color);

  } else {
    // Get generic colors
    var generalCourseTags = oxfApp.courseData.courseTags;
    if (generalCourseTags != null && generalCourseTags.length) {
      $.each(generalCourseTags, function(index, value) {
        value = value.toLowerCase();

        if (oxfApp.startsWith(value, oxfApp.config.headerBackgroundTag)) {
          bgcolor = value.replace(oxfApp.config.headerBackgroundTag, '#');
          oxfApp.config.resourceHeaderBackground = bgcolor;
        }
        if (oxfApp.startsWith(value, oxfApp.config.breadcrumbColorTag)) {
          color = value.replace(oxfApp.config.breadcrumbColorTag, '#');
          oxfApp.config.breadcrumbColor = color;
        }
      });
    }


    $('.ox-module--header').css({'background-color': bgcolor, 'color': color});

  }


}


// Go to home
oxfApp.goHome = function() {
  var isBookCover = idclase.toString() === oxfApp.config.coverID;
  if (isBookCover) {
    window.location.hash = oxfApp.config.tree[0].hash;
  } else {
    var bookCoverAction = oxfApp.courseData.units[0].subunits[0].onclickTitle;
    eval(bookCoverAction);
  }
}

// Insert block between elements

oxfApp.addBlockBefore = function(block, id) {
  var refElement = document.getElementById(id);

  if (!refElement) {// Presumably atypical, hence not worrying about creating above
      return null;
  }
  refElement.parentNode.insertBefore(block, refElement);
}

// Get text align
oxfApp.getTextAlign = function (array) {
  if (array.indexOf(oxfApp.config.tagTextCenter) >= 0) {
    return "ox-ta-center";
  } else if (array.indexOf(oxfApp.config.tagTextUpCenter) >= 0) {
    return "ox-ta-center-up";
  } else if (array.indexOf(oxfApp.config.tagTextUpLeft) >= 0) {
    return "ox-ta-left-up";
  } else if (array.indexOf(oxfApp.config.tagTextUpRight) >= 0) {
    return "ox-ta-right-up";
  } else {
    return "ox-ta-left-up";
  }
};

oxfApp.createBarAbove = function () {
  return "";
};

oxfApp.createSearchBar = function () {
  var barSearch =
    '<div class="ox-searchbar"><div class="ox-container"><div class="ox-searchbar__inner"><div class="ox-searchform"><label class="ox-searchform__field"><input type="text" class="ox-searchform__field__input ox--js-triggersearch" placeholder="' +
    oxfApp.text.oxford_zona_recursos_2020_searchPlaceHolder +
    '" /><span class="ox-searchform__field__button"></span></label><div class="ox-searchform__results"><div class="ox-searchform__results__inner ox--js-resultslist"></div></div></div></div></div></div>';

  return barSearch;
};

oxfApp.customGenioxHTMLContent = function() {
  var closeButton = '<div class="ox-container"><a href="javascript:void(0)" class="ox-link ox-link--goback ox--js-closeActivity">'+oxfApp.icons.goback+oxfApp.text.oxford_zona_recursos_2020_exit+'</a></div>';
  $('.ox-navigation-wrapper').append(closeButton);

}

oxfApp.initBookUnitsSidebar = function() {
  var data = oxfApp.courseData;
  var currentBook = -1;
  var currentBookIndex = -1;

  data.units.map((unit, index) => {
    unit.subunits.map((subunit) => {
      if(subunit.id == window.idclase){
        for (n = index; n > 0; n--) {

          var unitTags = data.units[n].tags,
          unitTagsArray = (typeof unitTags !== 'undefined') ? unitTags.split(" ") : [];

          if (unitTagsArray.indexOf(oxfApp.config.tagBlockEbooks) >= 0) {
            currentBook = data.units[n].id;
            currentBookIndex = n;
            return;
          }
        }
      }
    });
  });

  var $bookwrapper = $(".content-wrapper.libro");

  var bookUnits = "";
  var bookThumbs = "";
  var bookResources = "";  
  var globalIndex = 1;

  $.each(data.units, function(i, unit) {
    var unitTags = unit.tags,
    unitTagsArray = (typeof unitTags !== 'undefined') ? unitTags.split(" ") : [];
    var isBookExamGenerator = unitTagsArray.indexOf(oxfApp.config.ebookExamsGenerator) >= 0;

    if (i > currentBookIndex && !isBookExamGenerator) {
      var isBlockEbook = unitTagsArray.indexOf(oxfApp.config.tagBlockEbook) >= 0;

      if (isBlockEbook) {
        var unitID = unit.id;

        var unitTitle = unit.title,
        onlyVisibleTeachers = unit.onlyVisibleTeachers;

        if (!onlyVisibleTeachers || (onlyVisibleTeachers && !oxfApp.config.isStudent)) {
          var noResources = unit.subunits.length < 2 && !unit.resources.length;
          var noResourcesClass = (noResources) ? '--no-resources' : '';

          var unitItem = '<li><a href="javascript:void(0)" title="'+unitTitle+'" data-target="'+unitID+'" class="'+noResourcesClass+'">'+unitTitle+'</a></li>';
          bookUnits += unitItem;

          var subunit = unit.subunits[0];
          if (typeof subunit === 'undefined') return;

          var pags = Array.isArray(subunit.pags) ? subunit.pags : [];
          var subunitThumb = "";
          var subunitId = subunit.id;
          var offset = (typeof subunit.offset !== 'undefined' && Number(subunit.offset) >= 0)
          ? Number(subunit.offset) + 1
          : 0;

        globalIndex += offset;

          $.each(pags, function(i, pag) {           
            if (i % 2) {
              return;
            }

            var thumb = (pag) ? pag.thumb : [];
            var pageIndex = i + 1;
            var nextPage = pags[pageIndex];
            var thumbNext = (typeof nextPage !== "null" && nextPage)
              ? nextPage.thumb
              : '';
            var page = globalIndex++;
            var pageNext = (typeof nextPage !== "null" && nextPage)
              ? '-' + globalIndex++
              : '';

            var otherBook = (window.idclase !== Number(subunitId)) ? 'data-onclick="' + subunit.onclickTitle + '"': '';

            var thumbWithPage = '<article class="ox-thumb"><a href="javascript:void(0)" '+otherBook+' class="ox-thumb__inner ox-js--goToPageBook" data-book-id="'+subunitId+'" data-page="'+pageIndex+'"><div class="ox-thumb__media"><img src="'+thumb+'" alt=""><img src="'+thumbNext+'" alt="" /></div><div class="ox-thumb__page">'+oxfApp.text.oxford_geniox_pags + ' ' + page+pageNext+'</div></a></article>';
            subunitThumb += thumbWithPage;
          });

          var unitThumbs = '<div class="ox-sidebar__thumbs" data-thumbs="'+unitID+'"><div class="ox-sidebar__thumbs__title">'+unitTitle+'</div><div class="ox-thumb__wrapper">'+subunitThumb+'</div></div>';
          bookThumbs += unitThumbs;

          // Resources of the UNIT (siblings subunits)
          var subunits = unit.subunits;
          var resourceList = "";

          $.each(subunits, function(i, resource) {
            if (i > 0) {
              var title = resource.title;
              var type = resource.type;
              var level = resource.level;
              var onClick = resource.onclickTitle;
              var resource = '<li class="ox-sidebar__list__item --'+type+' --level-'+level+'"><a href="javascript:void(0)" onclick="'+onClick+'">'+title+'</a></li>';
              resourceList += resource;
            }

          });
          var resources = unit.resources;
          var header = false;

          $.each(resources, function(i, resource) {
            var resourceTags = resource.tags,
            resourceTagsArray = typeof resourceTags !== "undefined" ? resourceTags.split(" ") : [];
            var isTeacherResource = resourceTagsArray.some(item => oxfApp.startsWith(item, oxfApp.config.tagResourceTeacher));
            if (isTeacherResource) {

              if (!header) {
                var headerHTML = oxfApp.getResourcesHeader();
                resourceList += headerHTML;

                header = true;
              }

              var title = resource.title;
              var id = resource.id;
              var type = "own";
              var level = 6;
              var onClick = resource.onclickTitle;
              var visible = resource.lock !== oxfApp.config.activityLocked;
              var visibility = (visible) ? 'visible' : 'not-visible';
              var button = (!oxfApp.config.isStudent) ? '<button class="ox-button ox-button--icon ox-button--icon-visibility ox-js--toggleResourceVisibility --'+visibility+'" idclase="'+id+'" data-visibility="'+visibility+'"></button>' : '';
              if (oxfApp.config.isStudent && visible || !oxfApp.config.isStudent) {
                var resource = '<li class="ox-sidebar__list__item --'+type+' --level-'+level+'"><a href="javascript:void(0)" onclick="'+onClick+'">'+title+'</a>'+button+'</li>';
                resourceList += resource;
              }
            }

          });

          bookResources += '<ul class="ox-sidebar__list --hidden" data-parent="'+unitID+'">'+resourceList+'</ul>';
        }

      } else {
        return false;
      }

    }
  });

  var buttonAddRecources = "";
  if (oxfApp.config.canAddResource) {
    buttonAddRecources = '<a href="javascript:void(0);" onclick="oxfApp.modalCreateResource()" class="ox-button ox-button--addresource">'+oxfApp.text.oxford_geniox_addresource+oxfApp.icons.addResource+'</a>';
  }

  var bookUnitsSidebarUnits = '<div class="ox-sidebar --hidden" id="ox-BookUnits"><div class="ox-sidebar__header"><h2 class="ox-sidebar__title">'+oxfApp.text.oxford_geniox_pageperunit+'</h2><button class="ox-link ox-js--closeSidebar">'+oxfApp.text.oxford_geniox_close+'</button></div><div class="ox-sidebar__body"><ol class="ox-sidebar__list ox-js--goToUnitList">'+bookUnits+'</ol></div><div class="ox-sidebar__thumbs__wrapper --hidden" id="ox-BookThumbs">'+bookThumbs+'<button class="ox-button ox-button--icon ox-button--icon--close-2 ox-js--closeThumbs"><span>'+oxfApp.text.oxford_geniox_close+'</span></button></div></div>';
  var bookUnitsSidebarResources = '<div class="ox-sidebar --hidden" id="ox-BookResources"><div class="ox-sidebar__header"><h2 class="ox-sidebar__title">'+oxfApp.text.oxford_geniox_resourcesperunit+'</h2><button class="ox-link ox-js--closeSidebar">'+oxfApp.text.oxford_geniox_close+'</button></div><div class="ox-sidebar__body"><ol class="ox-sidebar__list ox-js--openResourcesList">'+bookUnits+'</ol></div><div class="ox-sidebar__footer">'+buttonAddRecources+'</div><div class="ox-sidebar__resources__wrapper --hidden" id="ox-BookResourcesList">'+bookResources+'</div></div>';

  $bookwrapper.append(bookUnitsSidebarUnits).append(bookUnitsSidebarResources);

  blink.events.on('digitalbook:viewerLoaded', (function() {
    if (oxfApp.storage.getItem('currentBookPage') !== null) {
      var page = oxfApp.storage.getItem('currentBookPage');
      if (bpdf.changePageDesktop && bpdf.rc) bpdf.changePageDesktop.set(page); //TODO CHECK WHY IS FAILING 
      $('[data-page]').parent().removeClass('--current');
      $('[data-book-id="'+window.idclase+'"][data-page="'+oxfApp.storage.getItem('currentBookPage')+'"]').parent().addClass('--current');

      var target = $('[data-book-id="'+window.idclase+'"][data-page="'+oxfApp.storage.getItem('currentBookPage')+'"]').closest('[data-thumbs]').attr('data-thumbs');

      $('.ox-sidebar__list a[data-target]').parent().removeClass('--current');
      $('.ox-sidebar__list [data-target="'+target+'"]').parent().addClass('--current');
    }
    $('body').addClass('ox-book-loaded');

  }));
  blink.events.on('digitalbook:finishedRendering', (function() {
    //Show / Hide pins
    if (oxfApp.getBoolean(oxfApp.storage.getItem('showPins'))) {
      blink.activity.currentStyle.showPins(true);
    } else {
      blink.activity.currentStyle.showPins(false);
    }

  }));


}

oxfApp.initBookHTML = function () {
  var data = oxfApp.courseData;

  var $bookwrapper = $(".content-wrapper.libro");

  var barAbove = oxfApp.createBarAbove(data.title);

  var bookMenuIndex =
    '<a href="javascript:void(0)" class="ox-link-icon ox-js--toggleBookUnits">' +
    oxfApp.icons.units +
    '<span>'+oxfApp.text.oxford_geniox_pageperunit + '</span>' +
    "</a>";
  var bookMenuResources =
    '<a href="javascript:void(0)" class="ox-link-icon ox-js--toggleBookResources">' +
    oxfApp.icons.resources +
    '<span>'+oxfApp.text.oxford_geniox_resourcesperunit + '</span>' +
    "</a>";


  var showPinsChecked = oxfApp.getBoolean(oxfApp.storage.getItem('showPins')) ? 'checked="checked"' : '';

  var bookMenuPin =
    '<label class="ox-switch"><input type="checkbox" value="ox-show-pin" '+showPinsChecked+' class="ox-js--showPin"><span class="ox-switch__slider"></span><span class="ox-switch__label">' +
    oxfApp.text.oxford_geniox_showpins +
    "</span></label>";

  var closeButton = '<a href="javascript:void(0)" class="ox-link ox-link--goback ox--js-closeActivity">'+oxfApp.icons.goback+oxfApp.text.oxford_zona_recursos_2020_exit+'</a>';

  var bookMenu =
    '<div class="ox-book-navigation"><div class="ox-book-navigation__section">' +
    bookMenuIndex +
    bookMenuResources + bookMenuPin + '</div></div>';


  var $arrows = $(".slider-control"),
    $arrowLeft = $(".slider-control.left"),
    $arrowRight = $(".slider-control.right");

  var arrowLeftDisabled = $arrowLeft.is(".disabled"),
    arrowRightDisabled = $arrowRight.is(".disabled");

  var barNavigation =
    '<div class="ox-navigation-wrapper">' +
    closeButton+
    bookMenu +
    "</div>";

  if (arrowLeftDisabled && arrowRightDisabled) {
    $arrows.addClass("ox-hidden");
  }

  $arrowLeft.append(
    '<span class="ox-slider-control-text">' +
      oxfApp.text.oxford_zona_recursos_2020_prev +
      "</span>"
  );
  $arrowRight.prepend(
    '<span class="ox-slider-control-text">' +
      oxfApp.text.oxford_zona_recursos_2020_next +
      "</span>"
  );

  var viewnotsupported =
    '<div class="ox-disabledlandscape"><div class="ox-disabledlandscape__inner">' +
    oxfApp.text.oxford_zona_recursos_2020_viewnotsupported +
    "</div></div>";

  //FIX Close button
  $('#close-back-wrapper-button').addClass('ox--js-closeActivity');

  $bookwrapper.prepend(barAbove).append(barNavigation).append(viewnotsupported);

  oxfApp.initBookUnitsSidebar();

};

oxfApp.initActivitySlides = function() {

  var data = oxfApp.courseData;
  var unit = _.findWhere(data.units, {id: window.idtema.toString()});
  var subunit = _.findWhere(unit.subunits, {id: window.idclase.toString()});

  var unitTags = unit.tags,
      unitTagsArray = typeof unitTags !== "undefined" ? unitTags.split(" ") : [];


  var subunitTags = subunit.tags,
      subunitTagsArray = typeof subunitTags !== "undefined" ? subunitTags.split(" ") : [];
  var isExam = oxfApp.checkIsAbstractExam();
  
  var isAbstract =
      (unitTagsArray.indexOf(oxfApp.config.evauAbstracts) >= 0) && !isExam;          
  var isHTMLContent = (subunitTagsArray.indexOf(oxfApp.config.slideContent) >= 0 || subunitTagsArray.indexOf(oxfApp.config.tagCredits) >= 0);

  blink.events.on('activity:loaded', function() {
    if (isAbstract) {
      oxfApp.abstractsLastSlide();
      oxfApp.customGenioxFeedback();
    }

    if (isHTMLContent) {
      oxfApp.customGenioxHTMLContent();
    }
  });

  blink.events.on('slider:changed', function() {
    if (isAbstract) {
      oxfApp.abstractsLastSlide();
      oxfApp.customGenioxFeedback();
    }
  });

  blink.events.on('slide:update:correct', function() {
    if (isAbstract) {
      oxfApp.customGenioxFeedback();
    }
  });

}

oxfApp.blockDropdown = function (block) {
  var data = oxfApp.courseData;
  $.each(data.units, function (i, unit) {
    var unitInd = i;
    var isBeforeYouStart = unitInd === oxfApp.beforeYouStartUnit;
    if (!isBeforeYouStart) {
      var unitTags = unit.tags,
        unitTagsArray =
          typeof unitTags !== "undefined" ? unitTags.split(" ") : [];
      $.each(unitTagsArray, function (index, value) {
        value = value.toLowerCase();

        if (oxfApp.startsWith(value, oxfApp.config.nBlockBox)) {
          //nBlocks
          var isDropdown =
            unitTagsArray.indexOf(oxfApp.config.tagDropdown) >= 0;

          if (isDropdown) {
            var currentBlockID = "ox-nblock-" + unitInd;
            var isShown = oxfApp.storage.getItem(currentBlockID)
                ? oxfApp.getBoolean(oxfApp.storage.getItem(currentBlockID))
                : true,
              visibleClass = !isShown ? "" : "ox-visible",
              toggleButtonText = isShown
                ? oxfApp.text.oxford_zona_recursos_2020_hide
                : oxfApp.text.oxford_zona_recursos_2020_show,
              toggleButton =
                '<button class="ox-link ox--js-toggleBlock" data-text-shown="' +
                oxfApp.text.oxford_zona_recursos_2020_hide +
                '" data-text-hidden="' +
                oxfApp.text.oxford_zona_recursos_2020_show +
                '">' +
                toggleButtonText +
                "</button>";

            $("#" + currentBlockID)
              .addClass("ox-module--togglable")
              .addClass(visibleClass)
              .find(".ox-module__header")
              .append(toggleButton);
          }
        } else if (oxfApp.startsWith(value, oxfApp.config.nBlockBoxContent)) {
          //nBlocks content
          var unitID = unit.id;
          var textAlign = oxfApp.getTextAlign(unitTagsArray);
          $('.ox-card__inner[data-unitid="' + unitID + '"]').addClass(
            textAlign
          );
        }
      });
    }
  });
};

oxfApp.checkOxfordExamID = function() {
  var data = oxfApp.courseData;

  var oxfordExamUnit = data.units.filter(function(unit) {
    var tags = typeof unit.tags !== "undefined" ? unit.tags.split(" ") : [];
    return tags.indexOf(oxfApp.config.examOxford.toLowerCase()) > -1;
  });

  return oxfordExamUnit[0].id;
}

oxfApp.blockExams = function() {
  var data = oxfApp.courseData;

  var $blockCreated = '';
  var placeholder = 0;
  var nextPlaceholder = 0;
  var $page = $('.ox-page--home');

  var examGeneratorMain = false;
  var examBlocks = [];

  var unitTemplate = oxfApp.config.templateDefault,
      unitTemplateTotal = oxfApp.config.templateDefaultTotal;
  var unitTemplateVal = oxfApp.config.templateDefault;

  $.each(data.units, function (i, unit) {
    var unitTags = unit.tags,
    unitTagsArray = typeof unitTags !== "undefined" ? unitTags.split(" ") : [];

    var isExamGenerator = (unitTagsArray.indexOf(oxfApp.config.examGenerator) >= 0);
    var isExamGenerated = (unitTagsArray.indexOf(oxfApp.config.examGenerated) >= 0);
    var isExamOxford = (unitTagsArray.indexOf(oxfApp.config.examOxford) >= 0);
    var isExamOnline = (unitTagsArray.indexOf(oxfApp.config.examsOnline) >= 0);


    if (isExamGenerator && !examGeneratorMain) {
        examBlocks.push(i);
        examGeneratorMain = true;
    }


    if (isExamGenerated) {
        examBlocks.push(i);
    }

    if (isExamOxford) {
        examBlocks.push(i);
    }

    if (isExamOnline) {
        examBlocks.push(i);
    }

  });

  if (examBlocks.length && data.units[examBlocks[0] - 1]) {
    placeholder = examBlocks[0] - 1;
    $blockCreated = $('#ox-nblock-'+placeholder+' .ox-module__content .ox-grid');
    $blockCreated.empty();

    var mainBlocks = data.units.filter((unit, ix) => {
      var tags = (typeof unit.tags !== 'undefined') ? unit.tags.split(" ") : [];
      return tags.indexOf(oxfApp.config.nBlockBox) > -1 && ix > placeholder;
    })
    nextPlaceholder = mainBlocks[0].number - 1;

  }
  if (!$blockCreated.length) {
    var unit = oxfApp.courseData.units[placeholder],
        title = unit.title,
        color = (placeholder % 2 == 0) ? oxfApp.config.colorsPairs_1 : oxfApp.config.colorsPairs_2;

      // Get template and background
      var unitBg = oxfApp.config.backgroundDefault,
          unitBgImage = (typeof unit.image !== 'undefined') ? unit.image : '';

      var colorClass = oxfApp.getColorClass(unitBg);
      var $blockCreated = document.createElement('section');
      $blockCreated.className = 'ox-module ox-module--custom ox-module--nblock '+colorClass;
      $blockCreated.id = 'ox-nblock-'+placeholder;
      $blockCreated.innerHTML = '<div class="ox-container"><header class="ox-module__header"><h2 class="ox-title ox-title--2">'+title+'</h2></header><div class="ox-module__content"><div class="ox-grid"></div></div></section>';


      $($blockCreated).css({'background-color': unitBg, 'background-image' : 'url('+unitBgImage+')'}).find('.ox-grid').addClass('ox-grid--'+unitTemplate);

      var isPrepend = false;
      var max = oxfApp.courseData.units.length;
      for (n = placeholder; n < max; n++) {

        if ($('#ox-nblock-'+n).length && !isPrepend) {

          oxfApp.addBlockBefore($blockCreated, 'ox-nblock-'+n);
          $blockCreated = $($blockCreated).find('.ox-grid');

          isPrepend = true;
        }
      }

      if (!isPrepend) {
        $page[0].appendChild($blockCreated);
        $blockCreated = $($blockCreated).find('.ox-grid');
      }

  }

  var unit = oxfApp.courseData.units[placeholder];
  var unitTags = unit.tags,
      unitTagsArray = (typeof unitTags !== 'undefined') ? unitTags.split(" ") : [];

  if (unitTagsArray.length) {

    $.each(unitTagsArray, function(index, value) {
      value = value.toLowerCase();

      if (oxfApp.startsWith(value, oxfApp.config.nBlockBoxTemplate)) {
        unitTemplateVal = value.replace(oxfApp.config.nBlockBoxTemplate, '');
        unitTemplate = oxfApp.getTemplate(unitTemplateVal)[0];
        unitTemplateTotal = oxfApp.getTemplate(unitTemplateVal)[2];
      }
    });
  }

  examGeneratorMain = false;

  $.each(data.units, function (i, unit) {
    var unitTags = unit.tags,
        unitTagsArray = typeof unitTags !== "undefined" ? unitTags.split(" ") : [];

    var isExamGenerator = (unitTagsArray.indexOf(oxfApp.config.examGenerator) >= 0);
    var isExamGenerated = (unitTagsArray.indexOf(oxfApp.config.examGenerated) >= 0);
    var isExamOxford = (unitTagsArray.indexOf(oxfApp.config.examOxford) >= 0);
    var isExamOnline = (unitTagsArray.indexOf(oxfApp.config.examsOnline) >= 0);

    var isOtherItem = (!isExamGenerator && !isExamGenerated && !isExamOxford && !isExamOnline && i < nextPlaceholder && i > placeholder);

    var item = unit,
    itemTitle = item.title,
    itemTitle = itemTitle.replace( /\((.+)\)/ , '' ),
    itemID = item.id,
    itemDescription = (typeof item.description.split(';')[0] !== 'undefined') ? item.description.split(';')[0] : item.description,
    itemBackground = item.image,
    itemBackgroundStyle = (typeof itemBackground !== 'undefined' && itemBackground !== '') ? 'background-image: url(\''+itemBackground+'\');' : '',
    itemBackgroundStyleClass = (typeof itemBackground !== 'undefined' && itemBackground !== '') ? 'ox-wimage' : 'ox-noimage',
    itemBg = '',
    gridClass = '',
    itemBgStyle = '';
    var color = (i % 2 == 0) ? oxfApp.config.colorsPairs_1 : oxfApp.config.colorsPairs_2;

    // Get background color
    var bgcolorTag = unitTagsArray.filter((tag) => {
      return oxfApp.startsWith(tag, oxfApp.config.boxBg);
    });

    if (bgcolorTag.length) {
      itemBg = bgcolorTag[0].replace(oxfApp.config.boxBg, '#');
      itemBgStyle = 'background-color: '+itemBg+';';
    }
    
    // Get action
    var itemsChildrenLength = item.subunits.length;
    var itemOnclickTitle = (itemsChildrenLength == 1) ? item.subunits[0].onclickTitle : '';
    var itemAction = (itemsChildrenLength == 1) ? 'onclick="'+itemOnclickTitle+'"' : 'data-unitid="'+itemID+'"',
        itemClass = (itemsChildrenLength > 1 || itemsChildrenLength == 0) ? ' ox--js-goto-resourceslist' : '';

    if (isExamGenerator && !oxfApp.config.isStudent && !examGeneratorMain) {
      if (oxfApp.config.canGenerateExam) {
        var itemAction =  'onclick="oxfApp.onGenerateExam()"',
            itemClass = '';
      } else {
        var itemAction = '',
            itemClass = '',
            gridClass = 'ox-generator--disabled',
            itemBackgroundStyleClass = '',
            itemBackgroundStyle = '',
            itemBgStyle = '',
            itemDescription = oxfApp.text.oxford_zona_recursos_2020_nogenerator,
            color = '',
            itemTitle = '';
      }
      examGeneratorMain = true;
      var itemCard = '<div class="ox-grid__item '+gridClass+'"><article class="ox-card '+itemBackgroundStyleClass+'" style="'+itemBackgroundStyle+itemBgStyle+'"><a class="ox-card__inner '+itemClass+'" href="javascript:void(0)" '+itemAction+'><h4 class="ox-title ox-title--5">'+itemDescription+'</h4><h3 class="ox-title ox-title--3" style="color: #'+color+'">'+itemTitle+'</h3></a></article></div>';
      $blockCreated.append(itemCard);

    }

    if (isExamGenerated) {
      var itemAction =  '',
          itemClass = ' ox--js-goto-generatedexams';
      
      if (oxfApp.config.isStudent) {

        var imageActivity = item.resources.filter(obj => {
          return obj.type === 'img'
        })[0];

        itemBackgroundStyle = (imageActivity) ? 'background-image: url(\''+imageActivity.fileurl+'\');' : itemBackgroundStyle;
        itemBackgroundStyleClass = (imageActivity) ? 'ox-wimage' : itemBackgroundStyleClass;

      }

      var itemCard = '<div class="ox-grid__item '+gridClass+'"><article class="ox-card '+itemBackgroundStyleClass+'" style="'+itemBackgroundStyle+itemBgStyle+'"><a class="ox-card__inner '+itemClass+'" href="javascript:void(0)" '+itemAction+'><h4 class="ox-title ox-title--5">'+itemDescription+'</h4><h3 class="ox-title ox-title--3" style="color: #'+color+'">'+itemTitle+'</h3></a></article></div>';
      $blockCreated.append(itemCard);

    }

    if (isExamOxford && oxfApp.examOxfordData && !oxfApp.config.isStudent) {
      var itemAction =  '',
          itemClass = ' ox--js-goto-oxfordexams';

      oxfApp.config.oxfordExamsId = itemID;

      var itemCard = '<div class="ox-grid__item '+gridClass+'"><article class="ox-card '+itemBackgroundStyleClass+'" style="'+itemBackgroundStyle+itemBgStyle+'"><a class="ox-card__inner '+itemClass+'" href="javascript:void(0)" '+itemAction+'><h4 class="ox-title ox-title--5">'+itemDescription+'</h4><h3 class="ox-title ox-title--3" style="color: #'+color+'">'+itemTitle+'</h3></a></article></div>';
      $blockCreated.append(itemCard);
    }

    if (isExamOnline) {
      itemClass += ' ox--exams-online';
      var itemCard = '<div class="ox-grid__item '+gridClass+'"><article class="ox-card '+itemBackgroundStyleClass+'" style="'+itemBackgroundStyle+itemBgStyle+'"><a class="ox-card__inner '+itemClass+'" href="javascript:void(0)" '+itemAction+'><h4 class="ox-title ox-title--5">'+itemDescription+'</h4><h3 class="ox-title ox-title--3" style="color: #'+color+'">'+itemTitle+'</h3></a></article></div>';
      $blockCreated.append(itemCard);
    }

    if (isOtherItem) {
      var singleActivity = unit.subunits.length === 1;
      itemAction = (singleActivity) ? 'onclick="'+unit.subunits[0].onclickTitle+'"' : 'data-unitid="'+itemID+'"';
      itemClass = (singleActivity) ? '' : 'ox--js-goto-resourceslist';

      
      var itemCard = '<div class="ox-grid__item '+gridClass+'"><article class="ox-card '+itemBackgroundStyleClass+'" style="'+itemBackgroundStyle+itemBgStyle+'"><a class="ox-card__inner '+itemClass+'" href="javascript:void(0)" '+itemAction+'><h4 class="ox-title ox-title--5">'+itemDescription+'</h4><h3 class="ox-title ox-title--3" style="color: #'+color+'">'+itemTitle+'</h3></a></article></div>';
      $blockCreated.append(itemCard); 
    }

    if ($blockCreated && ((isExamGenerated && oxfApp.courseData.hasExams )|| isExamOnline || isExamOxford || isOtherItem)) {
      var gridLength = $blockCreated.find('.ox-grid__item').length,
          templateLength = oxfApp.getTemplate(unitTemplateVal)[2];

      if (templateLength !== gridLength) {
        var template = oxfApp.getTemplateByLength(gridLength)[0];

        $blockCreated.closest('.ox-grid').removeClass(function (index, css) {
          return (css.match (/(^|\s)ox-grid--\S+/g) || []).join(' ');
       }).addClass('ox-grid--'+template);
      } else {

        $blockCreated.closest('.ox-grid').removeClass(function (index, css) {
          return (css.match (/(^|\s)ox-grid--\S+/g) || []).join(' ');
       }).addClass('ox-grid--'+unitTemplate);
      }
    }
  });
}

oxfApp.prepareToEbooks = function () {
  var data = oxfApp.courseData;

  $.each(data.units, function (index, unit) {
    var unitID = unit.id;
    var tags = (typeof unit.tags !== 'undefined') ? unit.tags.split(" ") : [];

    var pattern = oxfApp.config.tagBlockEbook;
    var pattern2 = oxfApp.config.tagBlockEbooks;
    var isEbookContent =
      tags.indexOf(pattern) >= 0 && tags.indexOf(pattern2) < 0;

    if (isEbookContent) {
      var onclick = (unit.subunits.length) ? unit.subunits[0].onclickTitle : 'nothing';
      $('.ox-card__inner[data-unitid="' + unitID + '"]')
        .closest(".ox-grid__item")
        .remove();

      $('.ox-card__inner[onclick="' + onclick + '"]')
        .closest(".ox-grid__item:not(:first-child)")
        .remove();
    }

    // Remove hidden content in Ebook module 

    if (index > 1) {
      var prevIndex = index - 1;
      var previousTags = (data.units[prevIndex] && typeof data.units[prevIndex].tags !== 'undefined') ? data.units[prevIndex].tags : [];

      var isAfterEbookContent =
        !isEbookContent &&
        previousTags.indexOf(pattern) >= 0 &&
        previousTags.indexOf(pattern2) < 0;

      if (isAfterEbookContent) {
        $('.ox-card__inner[data-unitid="' + unitID + '"]')
          .closest(".ox-grid__item")
          .nextAll(".ox-grid__item--empty")
          .remove();
      } 
    }

    // Add click to Ebook cover

    var isEbookCover = tags.indexOf(pattern2) >= 0;

    if (isEbookCover) {
      var nextEbook = data.units[index + 1].subunits[0];

      if (nextEbook) {
        $('.ox-card__inner[data-unitid="' + unitID + '"]').removeClass('ox--js-goto-resourceslist').attr('onclick', nextEbook.onclickTitle);
      }
    }

    // Remove empty items out of grid in other modules
    var tagTemplate = tags.filter(function isTemplate(value) {
      return oxfApp.startsWith(value, oxfApp.config.nBlockBoxTemplate);
    });

    if (!tagTemplate.length) return;
    tagTemplate = tagTemplate[0].replace(oxfApp.config.nBlockBoxTemplate, '');

    var templateData = oxfApp.getTemplate(tagTemplate);
    var templateMax = templateData[2] - 1;
    
    var lastItem = $('#ox-nblock-'+index+' .ox-grid__item:eq('+templateMax+')');

    $(lastItem).nextAll(".ox-grid__item--empty").remove();

  });
};

oxfApp.secondLevelView = function () {
  var currentHash = window.location.hash.replace('#','');
  if (currentHash.startsWith(oxfApp.config.tree[3].hash)) { // Resources
    $('.ox-page--resourcessection').addClass('loading');
    var unitID = currentHash.replace(oxfApp.config.tree[3].hash, ''),
        unitIDExists = (oxfApp.config.unitsNblockIDs.indexOf(unitID) >= 0);

    if (unitID !== '' && unitID !== null && unitIDExists) {
      var resourceInfo = oxfApp.getResourcesInfo(unitID);

      // Resources
      var subunits = resourceInfo[1].data.subunits,
          subunitsItems = '',
          subunitsItemsSkeleton = '';

      var backgroundColorImage = '#ffffff';

      var parentTags = resourceInfo[1].data.tags;
      var parentTags = (typeof parentTags !== 'undefined') ? parentTags.split(" ") : [];

      var hasCardsView = parentTags.indexOf(oxfApp.config.cardView) > -1;
      var hasAbstractView = parentTags.indexOf(oxfApp.config.evauAbstracts) > -1;
      var hasEvauExamView = parentTags.indexOf(oxfApp.config.evauExams) > -1;
      var hasExamOnlineView = parentTags.indexOf(oxfApp.config.examsOnline) > -1;
      var isEbookCover = parentTags.indexOf(oxfApp.config.tagBlockEbook ) > -1;

      if (isEbookCover) {
        $('.ox-page--resourcessection .ox-resourceslist').remove();
        var action = subunits[0].onclickTitle;
        var onclickfunction = eval(action)
        if (typeof onclickfunction == 'function') {
          onclickfunction()
        }
      }

      if (hasCardsView) {

         if (parentTags != null && parentTags.length) {
          $.each(parentTags, function(index, value) {
            value = value.toLowerCase();
            if (oxfApp.startsWith(value, oxfApp.config.boxBg )) {
              backgroundColorImage = value.replace(oxfApp.config.boxBg, '#');
            }
          });
        }

        if (subunits.length) {
          $.each(subunits, function(i, subunit) {

            var title = subunit.title,
                id = subunit.id,
                onclickTitle = subunit.onclickTitle,
                type = subunit.type,
                onlyVisibleTeachers = subunit.onlyVisibleTeachers,
                image = subunit.image,
                description = subunit.description;

            if (type === 'archivo') {
              var fileurl = subunit.fileurl,
                  type = oxfApp.getFileType(fileurl);
            }
             var linktext = oxfApp.getTextbyFileType(type);

            if (!onlyVisibleTeachers || (onlyVisibleTeachers && !oxfApp.config.isStudent)) {
              subunitsItems += '<article class="ox-resource ox-resource--card --'+type+'"><a href="javascript:void(0)" class="ox-resource__inner" onclick="'+onclickTitle+'"><div class="ox-resource__image" style="background-color: '+backgroundColorImage+'; background-image: url('+image+'); "></div><div class="ox-resource__body"><h3 class="ox-resource__title">'+title+'</h3><div class="ox-resource__description">'+description+'</div></div><div class="ox-resource__textlink">'+linktext+'</div></a></article>';
            }

          });

          subunitsItemsSkeleton = (subunitsItems !== '') ? '<section class="ox-resourceslist ox-resourceslist--cards"><div class="ox-container"><div class="ox-resourceslist__inner">'+subunitsItems+'</div></div></section>' : '';

        }

      }

      if (hasAbstractView) {

         if (parentTags != null && parentTags.length) {
          $.each(parentTags, function(index, value) {
            value = value.toLowerCase();
            if (oxfApp.startsWith(value, oxfApp.config.boxBg )) {
              backgroundColorImage = value.replace(oxfApp.config.boxBg, '#');
            }
          });
        }

        if (subunits.length) {
          var currentUnitTitle = null;
          var currentUnitImage = null;

          $.each(subunits, function(i, subunit) {
            if (subunit.level === "1") {
              currentUnitTitle = subunit.title;
              currentUnitImage = subunit.image;
            }

            var nextSubunit = subunits[i + 1];
            var prevSubunit = subunits[i - 1];
            var examType = (prevSubunit && prevSubunit.level === "6");

            if (subunit.level !== "1" && !examType && subunit.type !== 'archivo') {

                var title = subunit.title,
                id = subunit.id,
                onclickTitle = subunit.onclickTitle,
                type = subunit.type,
                onlyVisibleTeachers = subunit.onlyVisibleTeachers,
                image = currentUnitImage,
                description = subunit.description;

                var downloadableSubunit = subunits[i + 2];
                var isDownloadable = (downloadableSubunit) ? downloadableSubunit.type === 'archivo' : false;
                var downloadable = (isDownloadable) ? '<a class="ox-resource__download" href="'+downloadableSubunit.fileurl+'" download>'+oxfApp.text.oxford_geniox_downloadFile+'<span>'+oxfApp.icons.download+'</span></a>' : '';

                var badge = '<span class="ox-badge">'+currentUnitTitle+'</span>';
                if (!onlyVisibleTeachers || (onlyVisibleTeachers && !oxfApp.config.isStudent)) {
                  subunitsItems += '<article class="ox-resource ox-resource--card ox-resource--card--2 --'+type+'"><a href="javascript:void(0)" class="ox-resource__inner" onclick="'+onclickTitle+'"><div class="ox-resource__image" style="background-color: '+backgroundColorImage+'; background-image: url('+image+'); ">'+badge+'</div><div class="ox-resource__body"><h3 class="ox-resource__title">'+title+'</h3><div class="ox-resource__description">'+description+'</div></div></a>'+downloadable+'</article>';
                }
            }

          });

          subunitsItemsSkeleton = (subunitsItems !== '') ? '<section class="ox-resourceslist ox-resourceslist--cards--2"><div class="ox-container"><div class="ox-resourceslist__inner">'+subunitsItems+'</div></div></section>' : '';
        }

      }

      if (hasEvauExamView) {
        if (subunits.length) {
          var currentUnitTitle = null;

          $.each(subunits, function(i, subunit) {
            if (subunit.level === "1") {
              currentUnitTitle = subunit.title;

              subunitsItems += '<header class="ox-resource-header"><h2 class="ox-resource-header__title">'+currentUnitTitle+'</h2></header>';

            }

            if (subunit.level === "6" && subunit.type !== 'archivo') {

                var title = subunit.title,
                id = subunit.id,
                onclickTitle = subunit.onclickTitle,
                type = subunit.type,
                onlyVisibleTeachers = subunit.onlyVisibleTeachers,
                lockStatus = subunit.lock,
                description = subunit.description;

                var gradeBadge = (oxfApp.config.isStudent) ? oxfApp.getGradeBagde(id) : false,
                    badge = gradeBadge,
                    gradeBadgeWrapper = (badge) ? '<span class="ox-resource__grade"><span class="ox-resource__grade__label">'+oxfApp.text.oxford_geniox_grade_label+'</span> '+badge+'</span>' : '';

                var canLockActivities = (typeof subunit.canLockActivity !== 'undefined' && subunit.canLockActivity);

                var visibilityByUser = (!onlyVisibleTeachers || (onlyVisibleTeachers && !oxfApp.config.isStudent));
                var lock = (lockStatus !== oxfApp.config.activityLocked) ? 'unlocked' : 'locked';
                var userType = (!canLockActivities) ? 'student' : 'not-student';
                var lockedButton = canLockActivities ? '<button data-id="'+window.idcurso+'" idclase="'+id+'" class="ox-button ox-button--lock --'+lock+' ox-js--toggleLock" data-status="'+lock+'"><span class="ox-button__icon --locked">'+oxfApp.icons.lockLocked+'</span><span class="ox-button__icon --unlocked">'+oxfApp.icons.lockUnlock+'</span></button>' : '<button data-id="'+window.idcurso+'" idclase="'+id+'" class="ox-button ox-button--lock --'+lock+'" disabled><span class="ox-button__icon --locked">'+oxfApp.icons.lockLocked+'</span><span class="ox-button__icon --unlocked">'+oxfApp.icons.lockUnlock+'</span></button>';
                //var viewButton = '<span class="ox-button ox-button--view"><span class="ox-button__icon">'+oxfApp.icons.eye+'</span></span>';
                var downloadableSubunit = subunits[i + 1];
                var isDownloadable = typeof downloadableSubunit !== 'undefined' && downloadableSubunit.type === 'archivo';
                var downloadButton = (isDownloadable) ? '<a class="ox-button ox-button--download" href="'+downloadableSubunit.fileurl+'" download><span class="ox-button__text">'+oxfApp.text.oxford_geniox_downloadFile+'</span><span class="ox-button__icon">'+oxfApp.icons.download+'</span></a>' : '';
                var onClickbyLockStatus = (lock === 'unlocked') ? 'onclick="'+onclickTitle+'"' : 'onclick="oxfApp.modalEvauExamLocked()"';

                var onClickbyUser = canLockActivities ? 'onclick="'+onclickTitle+'"' : onClickbyLockStatus;
                if (visibilityByUser) {
                  subunitsItems += '<article class="ox-resource ox-resource--card ox-resource--card--3 --'+userType+' --'+type+' --'+lock+'"><a href="javascript:void(0)" class="ox-resource__inner" '+onClickbyUser+'><div class="ox-resource__body"><h3 class="ox-resource__title">'+title+'</h3><div class="ox-resource__description">'+description+'</div>'+gradeBadgeWrapper+'</div></a>'+downloadButton+lockedButton+'</article>';
                }

            }

          });

          subunitsItemsSkeleton = (subunitsItems !== '') ? '<section class="ox-resourceslist ox-resourceslist--cards--3"><div class="ox-container"><div class="ox-resourceslist__inner">'+subunitsItems+'</div></div></section>' : '';
        }

      }

      if (hasExamOnlineView) {
        if (subunits.length) {

          $.each(subunits, function(i, subunit) {


            var title = subunit.title,
                id = subunit.id,
                onclickTitle = subunit.onclickTitle,
                customOnclickTitle = oxfApp.updateOnclickTitle(onclickTitle, 'resources_'+unitID),
                onlyVisibleTeachers = subunit.onlyVisibleTeachers;

             var gradeBadge = (oxfApp.config.isStudent) ? oxfApp.getGradeBagde(id) : false,
                isNew = !gradeBadge && oxfApp.config.isStudent,
                badge = (isNew) ? '<span class="ox-resource__tag">'+oxfApp.text.oxford_geniox_new+'</span><div class="ox-gradebadge ox-activity-new"><span class="ox-gradebadge__inner"></span></div>' : gradeBadge,
                gradeBadgeWrapper = (badge) ? '<span class="ox-resource__grade">'+badge+'</span>' : '';

            var isLocked = subunit.lock === oxfApp.config.activityLocked;
            var classLocked = (isLocked) ? '--locked' : '--unlocked';
						var canLockActivities = (typeof subunit.canLockActivity !== 'undefined' && subunit.canLockActivity);
            var actionsTeachers = (canLockActivities) ? '<button class="ox-button ox-button--toggleVisibility ox-js--toggleLock '+classLocked+'" idclase="'+id+'"><span class="ox-button__icon --icon-locked">'+oxfApp.icons.lockLocked+'</span><span class="ox-button__icon --icon-unlocked">'+oxfApp.icons.lockUnlock+'</span><span class="ox-button__text">'+oxfApp.text.oxford_geniox_toggleVisibility+'</span></button>' : '';

            if (!onlyVisibleTeachers || (onlyVisibleTeachers && !oxfApp.config.isStudent)) {
              subunitsItems += '<article class="ox-resource ox-resource--exam"><a href="javascript:void(0)" class="ox-resource__inner" onclick="'+customOnclickTitle+'"><span class="ox-resource__body"><h3 class="ox-resource__title">'+title+'</h3></span></a>'+gradeBadgeWrapper+actionsTeachers+'</article>';
            }


          });

        }
          var resourcesHeader = (oxfApp.config.isStudent) ? '<div class="ox-resourceslist__header"><span>'+oxfApp.text.oxford_geniox_exam_name+'</span><span>'+oxfApp.text.oxford_geniox_exam_grade+'</span></div>' : '<div class="ox-resourceslist__header"><span>'+oxfApp.text.oxford_geniox_exam_name+'</span><span>'+oxfApp.text.oxford_geniox_exam_status+'</span></div>';

          subunitsItemsSkeleton = (subunitsItems !== '') ? '<section class="ox-resourceslist ox-resourceslist--exams"><div class="ox-container">'+resourcesHeader+'<div class="ox-resourceslist__inner">'+subunitsItems+'</div></div></section>' : '<section class="ox-resourceslist ox-resourceslist--exams"><div class="ox-container">'+resourcesHeader+'<div class="ox-resourceslist__inner"></div></div></section>';
      }



      if (!hasCardsView && !hasAbstractView && !hasEvauExamView && !hasExamOnlineView) {
          var intervalLoadResourcesNotCustom = setInterval(function() {
            if ($('.ox-page--resourcessection .ox-resourcessection-header').length) {
              $('.ox-page--resourcessection').removeClass('loading');
              oxfApp.headerColorsGeniox(unitID);

              clearInterval(intervalLoadResourcesNotCustom);
            }

          }, 250);
      } else {
        var intervalLoadResources = setInterval(function() {
          if ($('.ox-page--resourcessection .ox-resourceslist').length) {
            $('.ox-page--resourcessection .ox-resourceslist').remove();
            $('.ox-page--resourcessection').append(subunitsItemsSkeleton);
            $('.ox-page--resourcessection').removeClass('loading');
            oxfApp.headerColorsGeniox(unitID);

            clearInterval(intervalLoadResources);
          }

        }, 250);
      }

    }

  } else if (currentHash.startsWith(oxfApp.config.tree[5].hash)) { //Oxford Exams

    $('.ox-page--oxfordexamssection').addClass('loading');

    var oxfordExamId = oxfApp.checkOxfordExamID();
    var resourceInfo = oxfApp.getResourcesInfo(oxfordExamId);

    var buttonBack = '<button class="ox-link ox-link--goback ox--js-gohome">'+oxfApp.icons.goback+oxfApp.text.oxford_zona_recursos_2020_goback+'</button>';
    var contentnavBar = '<div class="ox-resourcessection-navbar"><div class="ox-container"><div class="ox-resourcessection-navbar__inner">'+buttonBack+'</div></div></div>';

    var contentTitle = resourceInfo[1].title,
        contentDescription = resourceInfo[1].description,
        contentSubtitle = (typeof contentDescription.split(';')[0] !== 'undefined') ? contentDescription.split(';')[0] : contentDescription;

    var contentHeader = '<header class="ox-resourcessection-header"><div class="ox-container"><div class="ox-resourcessection-header__inner"><div class="ox-resourcessection-header__title"><h1 class="ox-title ox-title--3">'+contentTitle+'</h1></div><div class="ox-resourcessection-header__description"><h2 class="ox-subtitle">'+contentSubtitle+'</h2></div></div></div></header>';
    var contentBodyData = resourceInfo[1].data.subunits;
    var contentBody = '';
    var examBlock = '';

    $.each(contentBodyData, function(i, exam) {

      var title = exam.title;
      var level = exam.level;
      var onClick = exam.onclickTitle;

      var prev = contentBodyData[i-1];
      var next = contentBodyData[i+1];

      if (level == 1) {
        examBlock = '';
      }
      if (level == 6 && prev.level == 1) {
        var generalTitle = prev.title;
        var section = i - 1;

        examBlock = '<section class="ox-examblock-wrapper" data-section="'+section+'"><div class="ox-container"><div class="ox-examblock-wrapper__inner"><article class="ox-examblock"><button class="ox-examblock__title ox--js-togglecontent">'+generalTitle+'</button><div class="ox-examblock__content"><div class="ox-examblock__content__inner"><div class="ox-examblock__content__help">'+oxfApp.text.oxford_zona_recursos_2020_helpExam+'</div>';
      } 

      if (level == 6) {
        examBlock += '<div><a href="javascript:void(0)" onclick="'+onClick+'">'+title+'</a></div>';
      }

      if (level == 6 && (!next || next.level == 1)) {
        examBlock += '</div></div></article></div></div></section>';
      }
      
      contentBody += examBlock;
    });

    var intervalLoadResourcesNotCustom = setInterval(function() {
      if ($('.ox-page--oxfordexamssection .ox-module--header').length && $('.ox-page--oxfordexamssection .ox-examblock-wrapper').length) {
        //$('.ox-page--oxfordexamssection .ox-module--header').remove();
        $('.ox-page--oxfordexamssection .ox-examblock-wrapper').remove();
        //$('.ox-page--oxfordexamssection').prepend(contentHeader).append(contentBody).append(contentnavBar);
        $('.ox-page--oxfordexamssection').append(contentBody);

        //oxfApp.headerColorsGeniox(unitID);

        $('.ox-page--oxfordexamssection').removeClass('loading');
        clearInterval(intervalLoadResourcesNotCustom);
      }

    }, 250);

  }

}

window.addEventListener("hashchange", oxfApp.secondLevelView, false);


oxfApp.loadHomeGeniox = function () {
  $(".ox-module--header").after(oxfApp.createSearchBar());

  var $moduleFLoatingBubble = $("#ox-module-bys");

  var tagsCover = oxfApp.courseData.units[0].tags,
    tagsCoverArray =
      typeof tagsCover !== "undefined" ? tagsCover.split(" ") : [];

  var backgroundColor = "#e1f4f3";
  var borderColor = "#e1f4f3";

  $.each(tagsCoverArray, function (index, value) {
    value = value.toLowerCase();

    if (oxfApp.startsWith(value, oxfApp.config.tagBackgroundColorHelp)) {
      backgroundColor = value.replace(
        oxfApp.config.tagBackgroundColorHelp,
        "#"
      );
    }
    if (oxfApp.startsWith(value, oxfApp.config.tagBorderColorHelp)) {
      borderColor = value.replace(oxfApp.config.tagBorderColorHelp, "#");
    }
  });

  var styleNode = document.createElement("style");
  var styleText = document.createTextNode(
    "#ox-module-bys:not(.--visible) {background-color: " +
      backgroundColor +
      "; border-color: " +
      borderColor +
      "}"
  );
  styleNode.appendChild(styleText);
  document.getElementsByTagName("head")[0].appendChild(styleNode);

  var $floatingBubbleButton = $moduleFLoatingBubble.find(".ox--js-toggleBlock");
  $moduleFLoatingBubble
    .addClass("ox-floatingbubble")
    .removeClass("ox-module--togglable");

  $floatingBubbleButton
    .addClass("ox--js-toggleBubble")
    .removeClass("ox--js-toggleBlock")
    .attr("data-text-shown", "Volver")
    .wrapAll(
      '<div class="ox-floatingbubble__footer"><div class="ox-container"></div></div>'
    );

  oxfApp.storage.setItem("ox-module-bys", "false");

  var $scrollable = $(".ox-page");

  $scrollable.scroll(function () {
    var st = $(this).scrollTop();
    document.documentElement.style.setProperty("--st", st + "px");
  });


  //Dropdown functionality
  oxfApp.blockDropdown();

  // Remove Ebook content and prepare eBook link
  oxfApp.prepareToEbooks();

  // Add Exam block
  oxfApp.blockExams();

  //Custom header color

  oxfApp.headerColorsGeniox();

};

oxfApp.abstractsLastSlide = function() {
  var style = blink.activity && blink.activity.currentStyle;
  var totalSlides = style.Slider.$items.length,
    currentSection = blink.activity.currentSection,
    isLastSlide = (totalSlides === currentSection+2);

  var $next = $('.right.slider-control');
  var $review = $('#slider-item-'+currentSection).find('.review');

  if (isLastSlide && !$review.hasClass('ox-review--test')) {
    var buttonModalTest = '<button class="btn ox-btn--end ox-js--modalTest">'+oxfApp.text.oxford_geniox_test+'</button>';
    var reviewAppend = '<div class="ox-review--test__inner">'+buttonModalTest+'</div>';

    $review.addClass('ox-review--test').append(reviewAppend);
  }
  if (isLastSlide) {
    $next.hide();
  } else {
    $next.show();
  }
}

oxfApp.customGenioxFeedback = function() {

  var activeSlide = window.activeSlide;

  if (!activeSlide) return;
  var currentSlide = window['t'+activeSlide+'_slide'],
      attempts	= currentSlide.intentos,
      maxAttempts = currentSlide.numMaxIntentos;
  
      var allRight = !$('#transp'+activeSlide).find('.respuesta_ko').length;

  if (maxAttempts > attempts && !allRight) {
    $('#transp'+activeSlide).addClass('ox-trying');
    $('#transp'+activeSlide).removeClass('ox-no-attempts');
  } else {
    $('#transp'+activeSlide).removeClass('ox-trying');
    $('#transp'+activeSlide).addClass('ox-no-attempts');
  }
}

oxfApp.getExamsNotifications = function() {
  if (!oxfApp.config.isStudent || !oxfApp.courseData.hasExams) return;

  // Get all the exams

  var units = oxfApp.courseData.units;
  
  //var studentActivities = window.actividades;
  var studentActivities = [];

  $.each(units, function(i, unit) {
    var isExams = unit.isExams;
    if (isExams) {
      var subunits = unit.subunits;
      $.each(subunits, function(i, subunit) {
      var onlyVisibleTeachers = unit.onlyVisibleTeachers
      var isVisible = subunit.lock !== oxfApp.config.activityLocked && !onlyVisibleTeachers;
        if (isVisible) {
          var id = subunit.id;
          oxfApp.allExams.push(id);
          if (typeof studentActivities[id] === 'undefined') {
            var tags = typeof unit.tags !== "undefined" ? unit.tags.split(" ") : [];
            //If is ONLINE 
            if (tags.indexOf(oxfApp.config.examsOnline.toLowerCase()) >= 0) {
              oxfApp.newExamsOnline.push(id);
            } else {
              oxfApp.newExams.push(id);
            }            
          }

        }
      })
    }
  });

  oxfApp.showExamsNotifications();
}

oxfApp.showExamsNotifications = function() {
  var newExamsLength = oxfApp.newExams.length;

  // Generated exams
  if (newExamsLength) {
    var target = $('.ox-card .ox--js-goto-generatedexams').parent();
    var badge = '<span class="ox-badge --notification">'+newExamsLength+'</span>';

    target.append(badge);
  }

  // Online Exam
  var newExamsOnlineLength = oxfApp.newExamsOnline.length;

  if (newExamsOnlineLength) {
    var targetOnline = $('.ox-card .ox--exams-online').parent();
    var badgeOnline = '<span class="ox-badge --notification">'+newExamsOnlineLength+'</span>';

    targetOnline.append(badgeOnline);
  }

}

oxfApp.toggleLockActivity = function(idclase, callback) {
	idcurso = idcurso || window.idcurso;
  blink.activity.currentStyle.onCursoCambiarBloqueado(idclase, idcurso, callback);
}

oxfApp.startTestFromAbstract = function() {
  var data = oxfApp.courseData;
  var unit = _.findWhere(data.units, {id: window.idtema.toString()});
  var subunit = _.findIndex(unit.subunits, {id: window.idclase.toString()});

  var test = unit.subunits[subunit+1];

  var onclick = test.onclickTitle;
  var onclickfunction = eval(onclick)
  if (typeof onclickfunction == 'function') {
    onclickfunction();
  }

}

oxfApp.checkIsAbstractExam = function() {
  var data = oxfApp.courseData;
  var unit = _.findWhere(data.units, {id: window.idtema.toString()});
  var subunit = _.findIndex(unit.subunits, {id: window.idclase.toString()});


  var prevSubunit = unit.subunits[subunit - 1];
  var isExam = (prevSubunit && prevSubunit.level === "6" && subunit.type !== 'archivo');

  return isExam;
}

oxfApp.toggleLockStatus = function(id) {
  var button = $('.ox-button[idclase="'+id+'"]');
  var previousVisibility = button.attr('data-visibility');
  var newVisibility = previousVisibility === 'visible' ? 'not-visible' : 'visible';
  button.toggleClass('--visible').toggleClass('--not-visible');
  button.toggleClass('--locked').toggleClass('--unlocked');
  button.removeAttr('data-visibility');
  button.attr('data-visibility', newVisibility)
}

oxfApp.createNewResourceInList = function(resource, unitId) {
  if (typeof resource === 'undefined') return;

  var $parent = $('.ox-sidebar__list[data-parent="' + unitId + '"]'),
      header = $parent.find('.--own-resources-header'),
      resourceList = '';

  if (header.length === 0) {
      var headerHTML = oxfApp.getResourcesHeader();
      resourceList += headerHTML;
      header = ["1"];
  }

  var title = resource.title,
      id = resource.id,
      type = "own",
      level = 6,
      onClick = resource.onclickTitle,
      visibility = resource.lock !== oxfApp.config.activityLocked
          ? 'visible'
          : 'not-visible',
      button = (!oxfApp.config.isStudent)
          ? '<button class="ox-button ox-button--icon ox-button--icon-visibility ox-js--toggleResourceVisibility --' + visibility + '" idclase="' + id + '" data-visibility="' + visibility + '"></button>'
          : '';
  if (oxfApp.config.isStudent && visible || !oxfApp.config.isStudent) {
    resourceList += '<li class="ox-sidebar__list__item --' + type + ' --level-' + level + '"><a href="javascript:void(0)" onclick="' + onClick + '">' + title + '</a>' + button + '</li>';
  }

  $parent.append(resourceList);
}

oxfApp.getResourcesHeader = function() {
	return '<li class="ox-sidebar__list__item  --level-1 --own-resources-header"><ul><li><a href="javascript:void(0);">' + oxfApp.text.oxford_geniox_teacher_resources + '</a></li></ul></li>';
}


oxfApp.modalStartTest = function() {
  $('#ox-modal-starttest').remove();

  var modal = '<div class="ox-modal in ox-modal--alert" id="ox-modal-starttest"><div class="ox-modal__inner"><div class="ox-modal__message"><p>'+oxfApp.text.oxford_geniox_start_test_1+'</p><p>'+oxfApp.text.oxford_geniox_start_test_2+'</p></div><div class="ox-modal__footer"><button class="ox-button ox-button--2 ox-button--secondary" onclick="oxfApp.closeModalCustom(\'ox-modal-starttest\')">'+oxfApp.text.oxford_geniox_cancel+'</button><button class="ox-button ox-button--2 ox-button--cancel ox-js--startTest">'+oxfApp.text.oxford_geniox_start_test+'</button></div></div></div>';

  $('body').append(modal);
}

oxfApp.modalCompleteActivity = function() {
  $('#ox-modal-completeactivity').remove();

  var modal = '<div class="ox-modal in ox-modal--alert" id="ox-modal-completeactivity"><div class="ox-modal__inner"><div class="ox-modal__message"><p>'+oxfApp.text.oxford_geniox_complete_activity+'</p></div><div class="ox-modal__footer"><button class="ox-button ox-button--2 ox-button--cancel" onclick="oxfApp.closeModalCustom(\'ox-modal-completeactivity\')">'+oxfApp.text.oxford_geniox_accept+'</button></div></div></div>';

  $('body').append(modal);
}

oxfApp.modalEvauExamLocked = function() {
  $('#ox-modal-evauexamlocked').remove();

  var modal = '<div class="ox-modal in ox-modal--lockstatus" id="ox-modal-evauexamlocked"><div class="ox-modal__inner"><div class="ox-modal__message"><p>'+oxfApp.text.oxford_geniox_exam_evau_locked_1+'</p><p>'+oxfApp.text.oxford_geniox_exam_evau_locked_2+'</p></div><div class="ox-modal__footer"><button class="ox-button ox-button--2 ox-button--cancel" onclick="oxfApp.closeModalCustom(\'ox-modal-evauexamlocked\')">'+oxfApp.text.oxford_geniox_accept+'</button></div></div></div>';

  $('body').append(modal);
}

oxfApp.modalOnlineExamLocked = function(idclase) {
  $('#ox-modal-onlineexamlocked').remove();

  var modal = '<div class="ox-modal in ox-modal--lockstatus --locked" id="ox-modal-onlineexamlocked"><div class="ox-modal__inner"><div class="ox-modal__message"><p>'+oxfApp.text.oxford_geniox_exam_online_locked_1+'</p><p>'+oxfApp.text.oxford_geniox_exam_online_locked_2+'</p></div><div class="ox-modal__footer"><button class="ox-button ox-button--2 ox-button--cancel ox-button--secondary" onclick="oxfApp.closeModalCustom(\'ox-modal-onlineexamlocked\')">'+oxfApp.text.oxford_geniox_cancel+'</button><button class="ox-button ox-button--2 ox-button--cancel" onclick="oxfApp.toggleLockActivity(' + idclase + ', () => { oxfApp.closeModalCustom(\'ox-modal-onlineexamlocked\'); oxfApp.toggleLockStatus('+idclase+'); } )">'+oxfApp.text.oxford_geniox_unlock+'</button></div></div></div>';

  $('body').append(modal);
}


oxfApp.modalOnlineExamUnlocked = function(idclase) {
  $('#ox-modal-onlineexamunlocked').remove();

  var modal = '<div class="ox-modal in ox-modal--lockstatus --unlocked" id="ox-modal-onlineexamunlocked"><div class="ox-modal__inner"><div class="ox-modal__message"><p>'+oxfApp.text.oxford_geniox_exam_online_unlocked_1+'</p><p>'+oxfApp.text.oxford_geniox_exam_online_unlocked_2+'</p></div><div class="ox-modal__footer"><button class="ox-button ox-button--2 ox-button--cancel ox-button--secondary" onclick="oxfApp.closeModalCustom(\'ox-modal-onlineexamunlocked\')">'+oxfApp.text.oxford_geniox_cancel+'</button><button class="ox-button ox-button--2 ox-button--cancel" onclick="oxfApp.toggleLockActivity(' + idclase + ', () => { oxfApp.closeModalCustom(\'ox-modal-onlineexamunlocked\');oxfApp.toggleLockStatus('+idclase+'); } )">'+oxfApp.text.oxford_geniox_lock+'</button></div></div></div>';

  $('body').append(modal);
}


oxfApp.modalResourceLocked = function(idclase) {
  $('#ox-modal-resourcelocked').remove();

  var modal = '<div class="ox-modal in ox-modal--visibilitystatus --locked" id="ox-modal-resourcelocked"><div class="ox-modal__inner"><div class="ox-modal__message"><p>'+oxfApp.text.oxford_geniox_make_visible_1+'</p><p>'+oxfApp.text.oxford_geniox_make_visible_2+'</p></div><div class="ox-modal__footer"><button class="ox-button ox-button--2 ox-button--cancel ox-button--secondary" onclick="oxfApp.closeModalCustom(\'ox-modal-resourcelocked\')">'+oxfApp.text.oxford_geniox_cancel+'</button><button class="ox-button ox-button--2 ox-button--cancel" onclick="oxfApp.toggleLockActivity(' + idclase + ', () => { oxfApp.closeModalCustom(\'ox-modal-resourcelocked\');oxfApp.toggleLockStatus('+idclase+'); } )">'+oxfApp.text.oxford_geniox_make_visible+'</button></div></div></div>';

  $('body').append(modal);
}


oxfApp.modalResourceUnlocked = function(idclase) {
  $('#ox-modal-resourceunlocked').remove();

  var modal = '<div class="ox-modal in ox-modal--visibilitystatus --unlocked" id="ox-modal-resourceunlocked"><div class="ox-modal__inner"><div class="ox-modal__message"><p>'+oxfApp.text.oxford_geniox_hidden_1+'</p><p>'+oxfApp.text.oxford_geniox_hidden_2+'</p></div><div class="ox-modal__footer"><button class="ox-button ox-button--2 ox-button--cancel ox-button--secondary" onclick="oxfApp.closeModalCustom(\'ox-modal-resourceunlocked\')">'+oxfApp.text.oxford_geniox_cancel+'</button><button class="ox-button ox-button--2 ox-button--cancel" onclick="oxfApp.toggleLockActivity(' + idclase + ', () => { oxfApp.closeModalCustom(\'ox-modal-resourceunlocked\');oxfApp.toggleLockStatus('+idclase+'); } )">'+oxfApp.text.oxford_geniox_hidden+'</button></div></div></div>';

  $('body').append(modal);
}




oxfApp.modalCreateResource = function() {
  //oxfApp.newResource("#ox-BookResources");
  oxfApp.newResourceGeniox(".ox-contentsection-header");
}

oxfApp.closeModalCustom = function(id) {
  $('#'+id).remove();
}

//----------------------------------//
//                                  //
//  Document Ready                  //
//                                  //
//----------------------------------//

$(document).ready(function () {
  var intervalLoadHome = setInterval(initGeniox, 250);

  function initGeniox() {

    if ($('body').hasClass('edit')) return;

    var coverID = oxfApp.config.coverID;

    if (coverID && oxfApp.courseData !== "") {
      var isBookCover = idclase.toString() === coverID;
      var ishtmlBook = $('body').hasClass('body_htmlBook');

      if (isBookCover) {
        oxfApp.config.canLockActivities = (typeof oxfApp.courseData.canLockActivity !== 'undefined' && oxfApp.courseData.canLockActivity);
        oxfApp.loadHomeGeniox();
        oxfApp.secondLevelView();
        oxfApp.getExamsNotifications();

      } else if (!ishtmlBook) {
        oxfApp.initActivitySlides();
      }

      clearInterval(intervalLoadHome);
    }
  }

  $("body").on("click", ".ox--js-toggleBubble", function (e) {
    e.preventDefault();

    var block = $(this).closest(".ox-floatingbubble"),
      shown = block.hasClass("--visible"),
      text = shown
        ? $(this).attr("data-text-hidden")
        : $(this).attr("data-text-shown");

    if (shown) {
      block.removeClass("--visible");
      $("body").removeClass("ox-bubbleVisible");
    } else {
      block.addClass("--visible");
      $("body").addClass("ox-bubbleVisible");
    }

    $(this).text(text);
  });

  $("body").on("click", ".ox-js--toggleBookMenu", function(e) {
    e.preventDefault();
    var $nav = $(this).closest('.ox-book-navigation');

    if ($nav.hasClass('--hidden')) {
      $nav.removeClass('--hidden');
      $('body').addClass('oxBookNavigationShown');
      var text = $(this).attr('data-text-hide');
      $(this).text(text);
    } else {
      $nav.addClass('--hidden');
      $('body').removeClass('oxBookNavigationShown');
      var text = $(this).attr('data-text-show');
      $(this).text(text);
    }
  });

  $("body").on("click", ".ox-js--toggleBookUnits", function(e) {
    e.preventDefault();
    $('.ox-sidebar:not(#ox-BookUnits)').addClass('--hidden');
    $('#ox-BookResourcesList').addClass('--hidden');
    $('#ox-BookUnits').toggleClass('--hidden');

    $(this).toggleClass('--active').siblings().removeClass('--active');

    if ($('#ox-BookUnits').hasClass('--hidden')) {
      $('#ox-BookThumbs').addClass('--hidden');
    }

    if (!$('#ox-BookUnits').hasClass('--hidden') && bpdf) {
      $('.ox-js--goToPageBook').parent().removeClass('--current');
      var currentPage = bpdf.getVisiblePages()[1];
      $('[data-book-id="'+window.idclase+'"][data-page="'+currentPage+'"]').parent().addClass('--current');

      var target = $('[data-book-id="'+window.idclase+'"][data-page="'+currentPage+'"]').closest('[data-thumbs]').attr('data-thumbs');

      $('.ox-sidebar__list a[data-target]').parent().removeClass('--current');
      $('.ox-sidebar__list [data-target="'+target+'"]').parent().addClass('--current');

    }

  });

  $("body").on("click", ".ox-js--toggleBookResources", function(e) {
    e.preventDefault();

    $(this).toggleClass('--active').siblings().removeClass('--active');

    if (!$('#ox-BookResources').hasClass('--hidden')) {
      $('#ox-BookResourcesList').addClass('--hidden');
      $('#ox-BookThumbs').addClass('--hidden');
    }

    $('.ox-sidebar:not(#ox-BookResources)').addClass('--hidden');
    $('#ox-BookResources').toggleClass('--hidden');
    $('#ox-BookThumbs').addClass('--hidden');



  });

  $("body").on("click", ".ox-js--closeSidebar", function(e) {
    e.preventDefault();
    $('.ox-sidebar').addClass('--hidden');
    $('#ox-BookResourcesList').addClass('--hidden');
    $('#ox-BookThumbs').addClass('--hidden');

    $('.ox-js--toggleBookResources, .ox-js--toggleBookUnits').removeClass('--active');

  });

  $("body").on("click", ".ox-js--closeThumbs", function(e) {
    e.preventDefault();
    $('#ox-BookThumbs').addClass('--hidden');
  });


  $("body").on("click", ".ox-js--openResourcesList a", function(e) {
    e.preventDefault();
    var target = $(this).attr('data-target');
    var noResources = $(this).hasClass('--no-resources');

    if (noResources) return false;

    if ($('[data-parent="'+target+'"]').hasClass('--hidden')) {
      $('#ox-BookResourcesList').removeClass('--hidden');
      $('[data-parent="'+target+'"]').removeClass('--hidden').siblings().addClass('--hidden');

    } else {
      $('#ox-BookResourcesList').addClass('--hidden');
      setTimeout(function() {
        $('[data-parent="'+target+'"]').addClass('--hidden');
      }, 300);
    }

  });

  $("body").on("click", ".ox-js--goToUnitList a", function(e) {
    e.preventDefault();
    var target = $(this).attr('data-target');
    if ($('#ox-BookThumbs').hasClass('--hidden')) {
      $('#ox-BookThumbs').removeClass('--hidden');
    }

    var innerScroll = $('#ox-BookThumbs').scrollTop();
    var offset = ($('[data-thumbs="'+target+'"').length) ? $('[data-thumbs="'+target+'"').offset().top + innerScroll - 100 : false;

    if (!offset) return;

    $('#ox-BookThumbs').stop().animate({scrollTop: offset}, 600);

    $(this).parent().siblings().removeClass('--active');
    $(this).parent().addClass('--active');

  });


  $("body").on("click", ".ox-js--goToPageBook", function(e) {
    e.preventDefault();

    var hasOnclick = $(this).attr('data-onclick');
    var page = $(this).attr('data-page');
    if (hasOnclick) {
      var onclick = $(this).attr('data-onclick');
      var onclickfunction = eval(onclick)
      if (typeof onclickfunction == 'function') {
        onclickfunction()
      }
    } else {
      bpdf.changePageDesktop.set(page);

      $('.ox-js--goToPageBook').removeClass('--current');
      $(this).addClass('--current');

      $('.ox-sidebar').addClass('--hidden');
      $('#ox-BookThumbs').addClass('--hidden');
    }

    oxfApp.storage.setItem('currentBookPage', page);
  });


  $("body").on("click", ".ox-js--toggleLock", function(e) {
    e.preventDefault();
    var isLocked = $(this).hasClass('--locked');
    var idcurso = $(this).attr('data-id');
    var idclase = $(this).attr('idclase');

    if (isLocked) {
      oxfApp.modalOnlineExamLocked(idclase);
    } else {
      oxfApp.modalOnlineExamUnlocked(idclase);
    }
    e.stopPropagation();
  });

  $("body").on("click", ".ox-js--toggleResourceVisibility", function(e) {
    e.preventDefault();
    var visibility = $(this).attr('data-visibility');
    var idclase = $(this).attr('idclase');

    if (visibility !== "visible") {
      oxfApp.modalResourceLocked(idclase);
    } else {
      oxfApp.modalResourceUnlocked(idclase);
    }
    e.stopPropagation();
  });

  $("body").on("click", ".ox-js--modalTest", function(e) {
    e.preventDefault();
    oxfApp.modalStartTest();

  });

  $("body").on("click", ".ox-js--startTest", function(e) {
    e.preventDefault();
    oxfApp.startTestFromAbstract();
  });

  $("body").on("keypress", ".ox--js-triggersearch", function(e) {
    if (e.keyCode == 13) {
      var $link = $('.ox--js-resultslist .ox-result:first-child a');
      if ($link.length) {
        $link.click();
      }
      e.preventDefault();
      e.stopPropagation();
    }
  });

  $("body").on("change", ".ox-js--showPin", function(e) {

    var isChecked = $(this).is(":checked");

    if (isChecked) {
      blink.activity.currentStyle.showPins(true);
      oxfApp.storage.setItem("showPins", "true");

    } else {
      blink.activity.currentStyle.showPins(false);
      oxfApp.storage.setItem("showPins", "false");
    }
  });

	$('body').on('click', '.slider-control', function(e) {
		if ($(this).is('.not-allowed')) {
      e.preventDefault();
      oxfApp.modalCompleteActivity();
    }
	});

});

// ******************************************
// ADDED BY BLINK FOR ADDING RESOURCE FEATURE
// ******************************************

// Lanza el modal de subida de recursos personalizado para Geniox
oxfApp.newResourceGeniox = function(target = event.currentTarget) {
  var $target = $(target),
      isEdit = $target.hasClass('ox-button--edit'),
      idCourse = new URL(window.location.href).searchParams.get('idcurso'),
      idTema = window.location.hash.replace(/[^\d]*/, ''),
      idClass = $target.attr('data-id'),
      isResource = true,
      style = blink.activity && blink.activity.currentStyle,
      template = (style && style.uploadResourcesTpl) && style.uploadResourcesTpl,
      $modal = $('#remote-modal');

  dlgCreateNewEditClass(idCourse, idTema, idClass ? idClass : null, 1, null, isResource, null, null, null, template);

  // Añadimos/Quitamos la clase 'resources-modal'
  $modal.one('show.bs.modal', function() {
    oxfApp.inserTitle();
    oxfApp.insertUnitSelect(); // Modificamos el modal para añadir el selector de temas

    $modal
    	.addClass('resources-modal genioxResourcesUpload')
    	.one('hidden.bs.modal', function() {
	      $modal.removeClass('resources-modal');
	    });
  });

  // Si es creación de recurso -> se añade la tag level3...
  if (!isEdit) {
    var idSubunit = $target.attr('data-subunitid'),
        defaultTag = 'level3_resource' + (!idSubunit ? '' : '_' + idSubunit);

    // Añadimos la tag 'level3...' al mostrar el modal.
    $modal.one('shown.bs.modal', function() {
      var $tagsTarget = $("#hiddenTags");

      $tagsTarget.val() === "[]" && $tagsTarget.val('');

      blink.theme.setTag(defaultTag , "hidden", $tagsTarget);
    });
  }
};

oxfApp.inserTitle = function(){
  $(".modal-dialog").find(".modal-header").find("h4").html(oxfApp.text.oxford_geniox_addresource);
}

// Función para modificar los elementos del modal genérico de subida de archivos por los que necesitamos
oxfApp.insertUnitSelect = function() {
  let $keywords = $("#keywords");

  $keywords
    .parent()
    .addClass("form-select")
    .prepend(`<div class=custom-select><label for="selects">${textweb('oxford_geniox_select_resource_unit')}</label><select id='selects' class='placeholder'></select></div>`);
  $keywords.remove();

  $("body").addClass("upload-resources-modal");

  $selects = $("#selects");

  let unit_tags = ["block_ebook"],
  forbiddenTags = [oxfApp.config.ebookExamsGenerator]
  first_to_ignore = true;

  for (i = 0; i < oxfApp.courseData.units.length; i++) {
    var unit = oxfApp.courseData.units[i],
        already_in_select = false,
        forbidden = false;

    // Si la etiqueta está dentro de las no permitidas, no pintamos el tema.
    for (j = 0; j < forbiddenTags.length; j++) {
      var fbTag = forbiddenTags[j];
      unit.tags && unit.tags.indexOf(fbTag) !== -1 && (forbidden = true);
    }

    for (j = 0; j < unit_tags.length; j++) {
      var curTag = unit_tags[j];

      if (!already_in_select && unit.tags && unit.tags.indexOf(curTag) > -1 && !forbidden) {
        already_in_select = true;

        if (!first_to_ignore) {
          $selects.append(`<option value=${unit.id}>${unit.title}</option>`);
        } else {
          first_to_ignore = false;
        }
      }
    }
  }

  $selects.prepend(`<option value=0 selected>${textweb('oxford_geniox_select_resource_unit_label')}</option>`);

  $selects.on("change", () => {
    parseInt($selects.val()) === 0
      ? $selects.addClass("placeholder")
      : $selects.removeClass("placeholder");
  });    

  oxfApp.customizeSelects();

  const checkFields = () => {
    let $nombre = $("#nombre").val(),
        error = "",
        result = true;

        if ($nombre.length > 100) {
          error = "invalid_name";
        } else if ($nombre.length === 0) {
          error = "no_file_name";
        } else if ($("#files").html().length === 0) {
          error = "no_file_loaded";
        } else {
          result = false;
        }
        // ¿ No se quiere comprobar si $selects.val() === 0 ?
        // Si no se selecciona unidad ($selects.val() === 0) no se muestra ningún error ni se da feedback de ningún tipo.
    
        result &&
          $("#resourceForm")
            .find(".tab-content")
            .find(".tab-pane")
              .append(`<span class="error-msg">${textweb("oxford_geniox_select_resource_error_" + error)}</span>`);
    
        return result;
  }

  //Anulamos el evento genérico del botón y lo sustituimos por un ajax específico para este modal
  $("#botonOK").off().on("click", (e) => {
    $(".error-msg").remove();

    if (!checkFields()) {
      var name = $("#nombre").val(),
          targetUnitId = $selects.val();

      blink.ajax(
        "/LMS/ajax.php?op=activity.executeneweditclass&idcurso=" + window.idcurso + "&justrefresh=1",
        (result) => {
          if (result.startsWith("RELOAD")) {
            var select = $("#selects").val(),
                $modal_dialog = $(".modal-dialog"),
                $modal_content = $modal_dialog.find(".modal-body"),
                modalSuccessClass = 'modal-resource-success';

            $modal_dialog
              .addClass(modalSuccessClass)
              .find(".modal-header")
                .hide();
            $modal_content.html(`<div class="upload-resource-success"><div class="ok-circle"></div><p>${textweb("oxford_geniox_select_resource_upload_success_1")}</p><p>${textweb("oxford_geniox_select_resource_upload_success_2")}</p></div>`);
            $("#resources-buttons").html(`<button id="botonOK" class="btn btn-default" type="button">${textweb('oxford_geniox_select_resource_upload_success_accept')}</button>`);

            $("#botonOK").off().on("click", () => {
              $("#remote-modal, #modal-backdrop").addClass("hidden");
              $modal_dialog.removeClass(modalSuccessClass);
            });

            loadJSON(function(json) {
              oxfApp.courseData = json;
              /*
                var resourceId = file_upload_results.appId,
                  unit = _.findWhere(json.units, {id: select}),
                  resource = _.findWhere(unit.resources, {id: resourceId});

              // A partir de file_upload_results.appId, que contiene el id de la actividad asociada al recurso
              // cuando se hace la subida de este, tiene que sacar la actividad del courseData que acaba de actualizar,
              // y mandarlo como parámetro a su función, que debe ser llamada ahí.

              oxfApp.createNewResourceInList(resource, select);
              */

              var targetUnitResources = json.units.filter((unit) => unit.id === targetUnitId)[0].resources,
                  resource = targetUnitResources[targetUnitResources.length - 1];

              blink.theme.onCursoCambiarBloqueado(resource.id, idcurso, function(state) {
               // BK-26292 como es de nueva creación, el recurso siempre vendrá como locked.
               // No obstante, comprobamos que sea así, y cambiamos la propiedad lock para que
               // no sea necesario volver a llamar al cursoJson actualizado.
               state === 'lock'
                   && (resource.lock = oxfApp.config.activityLocked);

               oxfApp.createNewResourceInList(resource, targetUnitId);
              })
            });
          }
        },
        {
          async: true,
          data: {
            recurso: 1,
            tipoclase: 7,
            url: file_upload_results.url,
            hidden: 1,
            idtema: targetUnitId,
            nombre: name,
            hiddenTags: `{"resource_${new Date().getTime()}": "resource_${new Date().getTime()}", "resource_blocked": "resource_blocked"}`,
          },
        }
      );
    }
  });
}

var file_upload_results = {};

// Modificamos la función _createUploadFile para guardar por separado los datos del archivo subido y poder usarlos en nuestro código
function _createUploadFile(idButton, settings) {
  var mediatype = null;
  if (typeof getCurrentMediaType === "function") {
    mediatype = getCurrentMediaType();
  }
  var $progressContainer = $('#progress-'+idButton).parents('.progress-container'),
    $fileInputButton = $('#'+idButton).parent('.fileinput-button'),
    $uploadProgress = $('.'+idButton).find('.fs-upload-progress'),
    // Url del ajax del upload handler.
    url =  prefijoURL+'/LMS/ajax.php?op=uploadFile.upload' + (mediatype ? '&mediatype=' + mediatype : ''),
    // Cálculo del límite de tamaño en bytes.
    file_size_limit = changeToBytes(settings.file_size_limit),
    // Cálculo de la expresión regular de extensiones permitidas
    file_types_array = settings.file_types.match(/[0-9a-z]+/g),
    file_types = "(\.|\/)(";

  _.each(file_types_array, function(elem, i) {
    file_types += i > 0 ? "|" : "";
    file_types += elem;
  });

  file_types += ")$";
  var dropZone = ( ($('#'+idButton).parents('.tab-pane').length>0) ? $('#'+idButton).parents('.tab-pane') : $(document) );
  var optionsUpload = {
    url: url,
    dataType: 'json',
    maxFileSize: file_size_limit,
    acceptFileTypes: new RegExp(file_types, "i"), //file_types,
    formData: settings.post_params,
    dropZone: dropZone,
    done: function (e, data) {
      var result = data && data.result;
      file_upload_results = result.files[0];

      if (!result) {
        // Protección por si no viene respuesta.
        return optionsUpload.fail(false, {errorThrown: 'Error'});
      }

      $.each(result.files, function(index, file) {
        $files = $('#files').empty();
        $('<p/>').text(file.name).appendTo('#files');
      });

      // Alert informativo si el LIBRO DIGITAL de subida supera el tamaño de MFSIDZE
      if(typeof settings.isDigitalBookType !== "undefined" && typeof result.files[0].size !== "undefined" && settings.isDigitalBookType && result.files[0].size > MFSIDZE) {
        var formatedValueMaxSize = MFSIDZE / 1024 / 1024;
        _showAlert(textweb("upload_error_15", [formatedValueMaxSize]));
      }

      // Callback de la subida.
      settings.upload_success_handler(result.files[0], result.files[0].ruta, idButton);
      $progressContainer.addClass('hidden'); // Ocultar la barra de progreso.
      $fileInputButton.removeClass('disabled'); // Habilitar botón de subida.

    },
    fail: function (e, data) {
      var msg = "";
      if(data.jqXHR && data.jqXHR.responseText){
        msg = data.jqXHR.responseText;
        $("#resourceForm").find(".tab-content").find(".tab-pane").append(`<span class="error-msg">${msg.replace('ERROR','')}</span>`);
      }else{
        msg = data.errorThrown;
        $uploadProgress.text(msg);
      }
      blink.log.warning(msg);
      $progressContainer.addClass('hidden'); // Ocultar la barra de progreso.
      $fileInputButton.removeClass('disabled'); // Habilitar botón de subida.
    },
    progressall: function (e, data) {
      var progress = parseInt(data.loaded / data.total * 100, 10);
      $progressContainer.find('.progress-bar').css('width',  progress + '%');
    },
    processfail: function (e, data) {
      blink.log.warning('Error: ' + data.files[data.index].error);

      $progressContainer.addClass('hidden'); // Ocultar la barra de progreso.
      $fileInputButton.removeClass('disabled'); // Habilitar botón de subida.

      $.each(data.files, function (index, file) {
        $('<p/>').text(file.error).appendTo($uploadProgress);
      });
    },
    process: function (e, data) {
      blink.log.info('Processing ' + data.files[data.index].name);

       $("#resourceForm").find(".tab-content .tab-pane .error-msg").remove();

      $uploadProgress.empty(); // Vaciar el texto indicador de progreso.
      $progressContainer.removeClass('hidden'); // Mostrar la barra de progreso.
      $fileInputButton.addClass('disabled'); // Deshabilitar botón de subida
    }
  };

  // Si no se soporta la subida de jQuery, dehabilitar.
  $('#'+idButton)
    .fileupload(optionsUpload)
    .prop('disabled', !$.support.fileInput)
    .parent()
      .addClass($.support.fileInput ? undefined : 'disabled');
}

// Función para personalizar los select por CSS
oxfApp.customizeSelects = () => {
  var x, i, j, l, ll, selElmnt, a, b, c, d;
  /*look for any elements with the class "custom-select":*/
  x = document.getElementsByClassName("custom-select");
  l = x.length;
  for (i = 0; i < l; i++) {
    selElmnt = x[i].getElementsByTagName("select")[0];
    ll = selElmnt.length;
    /*for each element, create a new DIV that will act as the selected item:*/
    a = document.createElement("DIV");
    a.setAttribute("class", "select-selected");
    a.innerHTML = selElmnt.options[selElmnt.selectedIndex].innerHTML;
    x[i].appendChild(a);
    /*for each element, create a new DIV that will contain the option list:*/
    d = document.createElement("DIV");
    d.setAttribute("class", "select-items-container");
    b = document.createElement("DIV");
    b.setAttribute("class", "select-items select-hide");
    for (j = 1; j < ll; j++) {
      /*for each option in the original select element,
      create a new DIV that will act as an option item:*/
      c = document.createElement("DIV");
      c.innerHTML = selElmnt.options[j].innerHTML;
      c.addEventListener("click", function(e) {
          /*when an item is clicked, update the original select box,
          and the selected item:*/
          var y, i, k, s, h, sl, yl;
          s = this.parentNode.parentNode.parentNode.getElementsByTagName("select")[0];
          sl = s.length;
          h = this.parentNode.parentNode.previousSibling;
          for (i = 0; i < sl; i++) {
            if (s.options[i].innerHTML == this.innerHTML) {
              s.selectedIndex = i;
              h.innerHTML = this.innerHTML;
              y = this.parentNode.getElementsByClassName("same-as-selected");
              yl = y.length;
              for (k = 0; k < yl; k++) {
                y[k].removeAttribute("class");
              }
              this.setAttribute("class", "same-as-selected");
              break;
            }
          }
          h.click();
      });
      b.appendChild(c);
    }
    d.appendChild(b);
    x[i].appendChild(d);
    a.addEventListener("click", function(e) {
        /*when the select box is clicked, close any other select boxes,
        and open/close the current select box:*/
        e.stopPropagation();
        closeAllSelect(this);
        $(".select-items").toggle("select-hide");
        this.nextSibling.classList.toggle("no-hidden");
        this.classList.toggle("select-arrow-active");
      });
  }
  function closeAllSelect(elmnt) {
    /*a function that will close all select boxes in the document,
    except the current select box:*/
    var x, y, i, xl, yl, arrNo = [];
    x = document.getElementsByClassName("select-items");
    y = document.getElementsByClassName("select-selected");
    xl = x.length;
    yl = y.length;
    for (i = 0; i < yl; i++) {
      if (elmnt == y[i]) {
        arrNo.push(i)
      } else {
        y[i].classList.remove("select-arrow-active");
      }
    }
    for (i = 0; i < xl; i++) {
      if (arrNo.indexOf(i)) {
        x[i].classList.add("select-hide");
      }
    }
  }
  /*if the user clicks anywhere outside the select box,
  then close all select boxes:*/

  document.addEventListener("click", closeAllSelect);
}

